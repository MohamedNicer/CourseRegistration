<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Portal Router</title>
    
    <!-- Auth0 SDK -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    
    <style>
        body { font-family: Arial; margin: 0; padding: 20px; background: #f5f5f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .router-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 500px; text-align: center; }
        .loading { color: #0078d4; }
        .error { color: #dc3545; }
        .user-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .btn { padding: 12px 24px; margin: 5px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
        .btn-primary { background: #0078d4; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .role-selector { margin: 20px 0; }
        .role-btn { display: block; width: 100%; margin: 10px 0; padding: 15px; text-align: left; background: #f8f9fa; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; }
        .role-btn:hover { background: #e9ecef; }
    </style>
    
    <script>
        window.Auth0Config = {
            domain: "dev-jgb23rzjcvzqvvnj.us.auth0.com",
            clientId: "8DDdQBWPQcbEh1SPfp6IuDupaZ1S8o33",
            redirectUri: window.location.href.split('?')[0]
        };
        
        // **ROLE MAPPING SYSTEM**
        window.RoleMapping = {
            // Email-based role assignment for testing
            'alice.test@university.edu': { role: 'student', dbId: 1, name: 'Alice Johnson' },
            'bob.test@university.edu': { role: 'student', dbId: 2, name: 'Bob Williams' },
            'henry.test@university.edu': { role: 'student', dbId: 8, name: 'Henry Thomas' },
            'john.instructor@university.edu': { role: 'instructor', dbId: 1, name: 'John Smith' },
            'jane.instructor@university.edu': { role: 'instructor', dbId: 2, name: 'Jane Doe' },
            'admin.test@university.edu': { role: 'admin', dbId: 1, name: 'System Admin' },
            
            // Default mapping for unknown users (for testing)
            getRole: function(email) {
                return this[email.toLowerCase()] || { 
                    role: 'student', 
                    dbId: 1, 
                    name: 'Default User' 
                };
            }
        };
        
        let auth0Client = null;
        
        async function initRouter() {
            try {
                document.getElementById('status').innerHTML = 'üîê Initializing authentication...';
                
                auth0Client = await auth0.createAuth0Client({
                    domain: window.Auth0Config.domain,
                    clientId: window.Auth0Config.clientId,
                    authorizationParams: { 
                        redirect_uri: window.Auth0Config.redirectUri,
                        scope: 'openid profile email'
                    }
                });
                
                // Handle callback
                if (location.search.includes('code=')) {
                    document.getElementById('status').innerHTML = 'üîÑ Processing authentication...';
                    await auth0Client.handleRedirectCallback();
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                // Check if user is authenticated
                const isAuthenticated = await auth0Client.isAuthenticated();
                
                if (isAuthenticated) {
                    const user = await auth0Client.getUser();
                    await routeUser(user);
                } else {
                    showLoginOptions();
                }
                
            } catch (error) {
                console.error('Router initialization error:', error);
                showError('Authentication system error: ' + error.message);
            }
        }
        
        async function routeUser(user) {
            const roleInfo = window.RoleMapping.getRole(user.email);
            
            // Store user context for the target app
            localStorage.setItem('userContext', JSON.stringify({
                auth0User: user,
                roleInfo: roleInfo,
                timestamp: Date.now()
            }));
            
            document.getElementById('status').innerHTML = `
                <div class="user-info">
                    <h3>üëã Welcome, ${user.name || user.email}!</h3>
                    <p><strong>Email:</strong> ${user.email}</p>
                    <p><strong>Role:</strong> ${roleInfo.role.toUpperCase()}</p>
                    <p><strong>Database User:</strong> ${roleInfo.name}</p>
                </div>
                <p>üéØ Redirecting to ${roleInfo.role} portal...</p>
            `;
            
            // Redirect based on role
            setTimeout(() => {
                switch(roleInfo.role) {
                    case 'student':
                        window.location.href = '/app/student/webapp/index.html';
                        break;
                    case 'instructor':
                        window.location.href = '/app/instructor/webapp/index.html';
                        break;
                    case 'admin':
                        window.location.href = '/app/admin/webapp/index.html';
                        break;
                    default:
                        window.location.href = '/app/student/webapp/index.html';
                }
            }, 2000);
        }
        
        function showLoginOptions() {
            document.getElementById('status').innerHTML = `
                <h2>üéì University Portal System</h2>
                <p>Please login to access your portal</p>
                
                <div class="role-selector">
                    <h4>üé≠ Test Accounts (for demonstration):</h4>
                    <div class="role-btn" onclick="loginAsRole('alice.test@university.edu')">
                        <strong>üë©‚Äçüéì Student Portal</strong><br>
                        <small>alice.test@university.edu - High performing student</small>
                    </div>
                    <div class="role-btn" onclick="loginAsRole('henry.test@university.edu')">
                        <strong>üë®‚Äçüéì Student Portal (Limited)</strong><br>
                        <small>henry.test@university.edu - Student with low ECTS limit</small>
                    </div>
                    <div class="role-btn" onclick="loginAsRole('john.instructor@university.edu')">
                        <strong>üë®‚Äçüè´ Instructor Portal</strong><br>
                        <small>john.instructor@university.edu - Computer Science instructor</small>
                    </div>
                    <div class="role-btn" onclick="loginAsRole('admin.test@university.edu')">
                        <strong>‚öôÔ∏è Admin Portal</strong><br>
                        <small>admin.test@university.edu - System administrator</small>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="startLogin()">üîê Login with Auth0</button>
            `;
        }
        
        function loginAsRole(email) {
            // For demo purposes, simulate login with specific role
            const roleInfo = window.RoleMapping.getRole(email);
            const mockUser = {
                email: email,
                name: roleInfo.name,
                sub: 'demo-' + roleInfo.dbId
            };
            
            routeUser(mockUser);
        }
        
        function startLogin() {
            auth0Client.loginWithRedirect();
        }
        
        function showError(message) {
            document.getElementById('status').innerHTML = `
                <div class="error">
                    <h3>‚ùå Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">üîÑ Retry</button>
                </div>
            `;
        }
    </script>
</head>
<body onload="initRouter()">
    <div class="router-card">
        <div id="status" class="loading">üîÑ Loading portal router...</div>
    </div>
</body>
</html>
