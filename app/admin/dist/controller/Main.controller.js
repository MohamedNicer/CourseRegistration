sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/Fragment"],function(t,e,o,n,s){"use strict";return t.extend("admin.controller.Main",{onInit:function(){console.log("Admin Main Controller initialized");const t=new e({email:"",name:""});this.getView().setModel(t,"profile");const o=new e({students:[]});this.getView().setModel(o,"students");const n=new e({instructors:[]});this.getView().setModel(n,"instructors");const s=new e({courses:[]});this.getView().setModel(s,"courses");const r=new e({enrollments:[]});this.getView().setModel(r,"enrollments");this._tabsLoaded={students:false,instructors:false,courses:false,enrollments:false};this._charts={};this._chartData={};setTimeout(()=>{this._loadAdminProfile();this._loadStudents();this._tabsLoaded.students=true},500)},onAfterRendering:function(){console.log("Admin view rendered, checking for pending charts...");if(this._chartData.students){this._renderStudentChartsNow(this._chartData.students)}if(this._chartData.instructors){this._renderInstructorChartsNow(this._chartData.instructors)}if(this._chartData.courses){this._renderCourseChartsNow(this._chartData.courses)}if(this._chartData.enrollments){this._renderEnrollmentChartsNow(this._chartData.enrollments)}},onTabSelect:function(t){const e=t.getParameter("key");console.log("Tab selected:",e,"Already loaded:",this._tabsLoaded[e]);if(e==="students"&&!this._tabsLoaded.students){this._loadStudents();this._tabsLoaded.students=true}else if(e==="instructors"&&!this._tabsLoaded.instructors){console.log("Loading instructors tab for the first time");this._loadInstructors();this._tabsLoaded.instructors=true}else if(e==="courses"&&!this._tabsLoaded.courses){this._loadCourses();this._tabsLoaded.courses=true}else if(e==="enrollments"&&!this._tabsLoaded.enrollments){this._loadEnrollments();this._tabsLoaded.enrollments=true}},onNavBack:function(){window.location.href="/launchpad.html"},onLogout:async function(){if(typeof window.AuthService!=="undefined"){await window.AuthService.logout()}else{window.location.href="../../launchpad.html"}},_loadAdminProfile:async function(){try{if(typeof window.AuthService==="undefined"){console.error("AuthService not available");o.show("Authentication service not available");return}const t=await window.AuthService.getUser();console.log("Admin user:",t);const e=this.getView().getModel("profile");e.setProperty("/email",t.email||"");e.setProperty("/name",t.name||t.nickname||"Admin User")}catch(t){console.error("Failed to load admin profile:",t);this._handleError(t,"load admin profile")}},_loadStudents:async function(){const t=this.byId("studentTable");try{console.log("Loading students...");if(t){t.setBusy(true)}const e=await window.AuthService.getToken();const o=await fetch("/admin/Students?$expand=department",{headers:{Authorization:"Bearer "+e}});if(!o.ok){if(o.status===401){this._handleAuthError();return}else if(o.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${o.status}: ${o.statusText}`)}const n=await o.json();console.log("Students loaded:",n);const s=this.getView().getModel("students");s.setProperty("/students",n.value||[]);this._renderStudentCharts(n.value)}catch(t){console.error("Failed to load students:",t);this._handleError(t,"load students")}finally{if(t){t.setBusy(false)}}},_loadInstructors:async function(){console.log("_loadInstructors called");const t=this.byId("instructorTable");console.log("Instructor table found:",!!t);try{console.log("Loading instructors...");if(t){t.setBusy(true)}const e=await window.AuthService.getToken();const o=await fetch("/admin/Instructors?$expand=department",{headers:{Authorization:"Bearer "+e}});if(!o.ok){if(o.status===401){this._handleAuthError();return}else if(o.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${o.status}: ${o.statusText}`)}const n=await o.json();console.log("Instructors loaded:",n);const s=this.getView().getModel("instructors");s.setProperty("/instructors",n.value||[]);this._renderInstructorCharts(n.value)}catch(t){console.error("Failed to load instructors:",t);this._handleError(t,"load instructors")}finally{if(t){t.setBusy(false)}}},_loadCourses:async function(){const t=this.byId("courseTable");try{console.log("Loading courses...");if(t){t.setBusy(true)}const e=await window.AuthService.getToken();const o=await fetch("/admin/Courses?$expand=department,instructor",{headers:{Authorization:"Bearer "+e}});if(!o.ok){if(o.status===401){this._handleAuthError();return}else if(o.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${o.status}: ${o.statusText}`)}const n=await o.json();console.log("Courses loaded:",n);const s=this.getView().getModel("courses");s.setProperty("/courses",n.value||[]);this._renderCourseCharts(n.value)}catch(t){console.error("Failed to load courses:",t);this._handleError(t,"load courses")}finally{if(t){t.setBusy(false)}}},_loadEnrollments:async function(){const t=this.byId("enrollmentTable");try{console.log("Loading enrollments...");if(t){t.setBusy(true)}const e=await window.AuthService.getToken();const o=await fetch("/admin/Enrollments?$expand=student,course",{headers:{Authorization:"Bearer "+e}});if(!o.ok){if(o.status===401){this._handleAuthError();return}else if(o.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${o.status}: ${o.statusText}`)}const n=await o.json();console.log("Enrollments loaded:",n);const s=this.getView().getModel("enrollments");s.setProperty("/enrollments",n.value||[]);this._renderEnrollmentCharts(n.value)}catch(t){console.error("Failed to load enrollments:",t);this._handleError(t,"load enrollments")}finally{if(t){t.setBusy(false)}}},_renderStudentCharts:function(t){this._chartData.students=t;setTimeout(()=>{this._renderStudentChartsNow(t)},800)},_renderStudentChartsNow:function(t){const e={};t.forEach(t=>{const o=t.department?.departmentName||"Unknown";e[o]=(e[o]||0)+1});this._createPieChart("studentDeptChart","Students by Department",e);const o={"0-30":0,"31-60":0,"61-90":0,"90+":0};t.forEach(t=>{const e=t.ectsLimit||0;if(e<=30)o["0-30"]++;else if(e<=60)o["31-60"]++;else if(e<=90)o["61-90"]++;else o["90+"]++});this._createBarChart("studentStatsChart","ECTS Limit Distribution",o)},_renderInstructorCharts:function(t){this._chartData.instructors=t;setTimeout(()=>{this._renderInstructorChartsNow(t)},1e3)},_renderInstructorChartsNow:function(t){console.log("Rendering instructor charts with",t.length,"instructors");const e={};t.forEach(t=>{const o=t.department?.departmentName||"Unknown";e[o]=(e[o]||0)+1});console.log("Instructor dept counts:",e);this._createPieChart("instructorDeptChart","Instructors by Department",e);const o={};t.forEach(t=>{const e=t.department?.faculty||"Unknown";o[e]=(o[e]||0)+1});console.log("Instructor faculty counts:",o);this._createBarChart("instructorStatsChart","Instructors by Faculty",o)},_renderCourseCharts:function(t){this._chartData.courses=t;setTimeout(()=>{this._renderCourseChartsNow(t)},800)},_renderCourseChartsNow:function(t){const e={};t.forEach(t=>{const o=t.department?.departmentName||"Unknown";e[o]=(e[o]||0)+1});this._createPieChart("courseDeptChart","Courses by Department",e);const o={"Full (100%)":0,"High (75-99%)":0,"Medium (50-74%)":0,"Low (<50%)":0,Empty:0};t.forEach(t=>{const e=t.quota>0?t.enrolled/t.quota*100:0;if(e>=100)o["Full (100%)"]++;else if(e>=75)o["High (75-99%)"]++;else if(e>=50)o["Medium (50-74%)"]++;else if(e>0)o["Low (<50%)"]++;else o["Empty"]++});this._createBarChart("courseCapacityChart","Course Capacity Utilization",o)},_renderEnrollmentCharts:function(t){this._chartData.enrollments=t;setTimeout(()=>{this._renderEnrollmentChartsNow(t)},800)},_renderEnrollmentChartsNow:function(t){const e={};t.forEach(t=>{const o=t.status||"Unknown";e[o]=(e[o]||0)+1});const o={ENROLLED:"#0070F2",EXCELLENT:"#107E3E",VERY_GOOD:"#2B7D2B",GOOD:"#10B981",SATISFACTORY:"#F59E0B",PASSED:"#E9730C",FAILED:"#D04343",COMPLETED:"#107E3E",DROPPED:"#5B738B"};const n=Object.keys(e).map(t=>o[t]||"#999999");this._createPieChartWithColors("enrollmentStatusChart","Enrollments by Status",e,n);const s={"A (18-20)":0,"B (15-17.9)":0,"C (12-14.9)":0,"D (10-11.9)":0,"F (<10)":0,"No Grade":0};t.forEach(t=>{const e=t.grade;if(e===null||e===undefined){s["No Grade"]++}else if(e>=18)s["A (18-20)"]++;else if(e>=15)s["B (15-17.9)"]++;else if(e>=12)s["C (12-14.9)"]++;else if(e>=10)s["D (10-11.9)"]++;else s["F (<10)"]++});this._createBarChart("enrollmentTrendChart","Grade Distribution",s)},_createPieChart:function(t,e,o){const n=document.getElementById(t);if(!n){console.warn(`Canvas element ${t} not found`);return}if(this._charts[t]){this._charts[t].destroy()}const s=n.getContext("2d");this._charts[t]=new Chart(s,{type:"pie",data:{labels:Object.keys(o),datasets:[{data:Object.values(o),backgroundColor:["#0070F2","#E9730C","#107E3E","#C0399F","#5B738B","#D04343","#2B7D2B","#8B5CF6","#F59E0B","#10B981"]}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:e,font:{size:14}},legend:{position:"bottom"}}}})},_createPieChartWithColors:function(t,e,o,n){const s=document.getElementById(t);if(!s){console.warn(`Canvas element ${t} not found`);return}if(this._charts[t]){this._charts[t].destroy()}const r=s.getContext("2d");this._charts[t]=new Chart(r,{type:"pie",data:{labels:Object.keys(o),datasets:[{data:Object.values(o),backgroundColor:n}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:e,font:{size:14}},legend:{position:"bottom"}}}})},_createBarChart:function(t,e,o){const n=document.getElementById(t);if(!n){console.warn(`Canvas element ${t} not found`);return}if(this._charts[t]){this._charts[t].destroy()}const s=n.getContext("2d");this._charts[t]=new Chart(s,{type:"bar",data:{labels:Object.keys(o),datasets:[{label:"Count",data:Object.values(o),backgroundColor:"#0070F2"}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:e,font:{size:14}},legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}})},onAddStudent:async function(){await this._loadDepartments();const t=await this._generateNextStudentNumber();const o=new e({title:"Add New Student",mode:"create",studentNumber:t,firstName:"",lastName:"",email:"",ectsLimit:60,department_ID:null});this._openStudentDialog(o)},_generateNextStudentNumber:async function(){try{const t=await window.AuthService.getToken();const e=await fetch("/admin/Students?$orderby=studentNumber desc&$top=1",{headers:{Authorization:"Bearer "+t}});if(!e.ok){throw new Error("Failed to fetch students")}const o=await e.json();if(o.value&&o.value.length>0){const t=o.value[0].studentNumber;const e=t.match(/STU(\d+)/);if(e){const t=parseInt(e[1])+1;return`STU${String(t).padStart(3,"0")}`}}return"STU001"}catch(t){console.error("Failed to generate student number:",t);return"STU001"}},onEditStudent:async function(t){const o=t.getSource().getParent().getParent();const n=o.getBindingContext("students");const s=n.getObject();await this._loadDepartments();const r=new e({title:"Edit Student",mode:"edit",ID:s.ID,studentNumber:s.studentNumber,firstName:s.firstName,lastName:s.lastName,email:s.email,ectsLimit:s.ectsLimit,department_ID:s.department_ID});this._openStudentDialog(r)},_openStudentDialog:async function(t){if(!this._studentDialog){this._studentDialog=await s.load({id:this.getView().getId(),name:"admin.view.StudentDialog",controller:this});this.getView().addDependent(this._studentDialog)}this._studentDialog.setModel(t,"dialogModel");if(this._departmentsModel){this._studentDialog.setModel(this._departmentsModel,"departments")}else{console.error("Departments model not loaded!")}this._studentDialog.open()},onSaveStudent:async function(){const t=this._studentDialog.getModel("dialogModel");const e=t.getData();if(!e.studentNumber||!e.firstName||!e.lastName||!e.email||!e.department_ID){n.error("Please fill in all required fields");return}try{const t=await window.AuthService.getToken();const n=e.mode==="create"?"/admin/Students":`/admin/Students(${e.ID})`;const s=e.mode==="create"?"POST":"PATCH";const r={studentNumber:e.studentNumber,firstName:e.firstName,lastName:e.lastName,email:e.email,ectsLimit:parseInt(e.ectsLimit),department_ID:parseInt(e.department_ID)};const a=await fetch(n,{method:s,headers:{Authorization:"Bearer "+t,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok){throw new Error(`HTTP ${a.status}: ${a.statusText}`)}o.show(e.mode==="create"?"Student created successfully":"Student updated successfully");this._studentDialog.close();this.getView().getModel().refresh()}catch(t){console.error("Failed to save student:",t);n.error("Failed to save student. Please try again.")}},onDeleteStudent:async function(t){const e=t.getSource().getParent().getParent();const o=e.getBindingContext("students");const s=o.getObject();try{const t=await window.AuthService.getToken();const e=await fetch(`/admin/Enrollments?$filter=student_ID eq ${s.ID}&$expand=course`,{headers:{Authorization:"Bearer "+t}});if(!e.ok){throw new Error("Failed to check enrollments")}const o=await e.json();const r=o.value||[];let a=`Are you sure you want to delete student "${s.firstName} ${s.lastName}"?`;if(r.length>0){a+=`\n\n⚠️ CASCADE DELETE WARNING:\n\nThis will also delete ${r.length} enrollment(s):\n`;r.slice(0,5).forEach(t=>{a+=`\n• ${t.course?.courseName||"Unknown Course"} (${t.status})`});if(r.length>5){a+=`\n... and ${r.length-5} more`}}n.warning(a,{title:"Confirm Delete",actions:[n.Action.DELETE,n.Action.CANCEL],emphasizedAction:n.Action.DELETE,onClose:async t=>{if(t===n.Action.DELETE){await this._deleteStudent(s.ID)}}})}catch(t){console.error("Error checking cascade effects:",t);n.error("Failed to check related records. Please try again.")}},_deleteStudent:async function(t){try{const e=await window.AuthService.getToken();const n=await fetch(`/admin/Students(${t})`,{method:"DELETE",headers:{Authorization:"Bearer "+e}});if(!n.ok){throw new Error(`HTTP ${n.status}: ${n.statusText}`)}o.show("Student deleted successfully");this.getView().getModel().refresh()}catch(t){console.error("Failed to delete student:",t);n.error("Failed to delete student. Please try again.")}},onAddInstructor:async function(){await this._loadDepartments();const t=await this._generateNextInstructorId();const o=new e({title:"Add New Instructor",mode:"create",instructorId:t,firstName:"",lastName:"",email:"",department_ID:null});this._openInstructorDialog(o)},_generateNextInstructorId:async function(){try{const t=await window.AuthService.getToken();const e=await fetch("/admin/Instructors?$orderby=instructorId desc&$top=1",{headers:{Authorization:"Bearer "+t}});if(!e.ok){throw new Error("Failed to fetch instructors")}const o=await e.json();if(o.value&&o.value.length>0){const t=o.value[0].instructorId;const e=t.match(/INS(\d+)/);if(e){const t=parseInt(e[1])+1;return`INS${String(t).padStart(3,"0")}`}}return"INS001"}catch(t){console.error("Failed to generate instructor ID:",t);return"INS001"}},onEditInstructor:async function(t){const o=t.getSource().getParent().getParent();const n=o.getBindingContext("instructors");const s=n.getObject();await this._loadDepartments();const r=new e({title:"Edit Instructor",mode:"edit",ID:s.ID,instructorId:s.instructorId,firstName:s.firstName,lastName:s.lastName,email:s.email,department_ID:s.department_ID});this._openInstructorDialog(r)},_openInstructorDialog:async function(t){if(!this._instructorDialog){this._instructorDialog=await s.load({id:this.getView().getId(),name:"admin.view.InstructorDialog",controller:this});this.getView().addDependent(this._instructorDialog)}this._instructorDialog.setModel(t,"dialogModel");if(this._departmentsModel){this._instructorDialog.setModel(this._departmentsModel,"departments")}else{console.error("Departments model not loaded!")}this._instructorDialog.open()},onSaveInstructor:async function(){const t=this._instructorDialog.getModel("dialogModel");const e=t.getData();if(!e.instructorId||!e.firstName||!e.lastName||!e.email||!e.department_ID){n.error("Please fill in all required fields");return}try{const t=await window.AuthService.getToken();const n=e.mode==="create"?"/admin/Instructors":`/admin/Instructors(${e.ID})`;const s=e.mode==="create"?"POST":"PATCH";const r={instructorId:e.instructorId,firstName:e.firstName,lastName:e.lastName,email:e.email,department_ID:parseInt(e.department_ID)};const a=await fetch(n,{method:s,headers:{Authorization:"Bearer "+t,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok){throw new Error(`HTTP ${a.status}: ${a.statusText}`)}o.show(e.mode==="create"?"Instructor created successfully":"Instructor updated successfully");this._instructorDialog.close();this.getView().getModel().refresh()}catch(t){console.error("Failed to save instructor:",t);n.error("Failed to save instructor. Please try again.")}},onDeleteInstructor:async function(t){const e=t.getSource().getParent().getParent();const o=e.getBindingContext("instructors");const s=o.getObject();try{const t=await window.AuthService.getToken();const e=await fetch(`/admin/Courses?$filter=instructor_ID eq ${s.ID}`,{headers:{Authorization:"Bearer "+t}});if(!e.ok){throw new Error("Failed to check courses")}const o=await e.json();const r=o.value||[];let a=`Are you sure you want to delete instructor "${s.firstName} ${s.lastName}"?`;if(r.length>0){a+=`\n\n⚠️ CASCADE DELETE WARNING:\n\nThis instructor teaches ${r.length} course(s):\n`;r.slice(0,5).forEach(t=>{a+=`\n• ${t.courseCode}: ${t.courseName}`});if(r.length>5){a+=`\n... and ${r.length-5} more`}a+=`\n\nThese courses will have no instructor assigned.`}n.warning(a,{title:"Confirm Delete",actions:[n.Action.DELETE,n.Action.CANCEL],emphasizedAction:n.Action.DELETE,onClose:async t=>{if(t===n.Action.DELETE){await this._deleteInstructor(s.ID)}}})}catch(t){console.error("Error checking cascade effects:",t);n.error("Failed to check related records. Please try again.")}},_deleteInstructor:async function(t){try{const e=await window.AuthService.getToken();const n=await fetch(`/admin/Instructors(${t})`,{method:"DELETE",headers:{Authorization:"Bearer "+e}});if(!n.ok){throw new Error(`HTTP ${n.status}: ${n.statusText}`)}o.show("Instructor deleted successfully");this.getView().getModel().refresh()}catch(t){console.error("Failed to delete instructor:",t);n.error("Failed to delete instructor. Please try again.")}},onAddCourse:async function(){await this._loadDepartments();await this._loadInstructorsForDropdown();const t=new e({title:"Add New Course",mode:"create",courseCode:"",courseName:"",description:"",ects:6,semester:"Fall 2025",quota:30,enrolled:0,isActive:true,department_ID:null,instructor_ID:null});this._openCourseDialog(t)},onEditCourse:async function(t){const o=t.getSource().getParent().getParent();const n=o.getBindingContext("courses");const s=n.getObject();await this._loadDepartments();await this._loadInstructorsForDropdown();const r=new e({title:"Edit Course",mode:"edit",ID:s.ID,courseCode:s.courseCode,courseName:s.courseName,description:s.description,ects:s.ects,semester:s.semester,quota:s.quota,enrolled:s.enrolled,isActive:s.isActive,department_ID:s.department_ID,instructor_ID:s.instructor_ID});this._openCourseDialog(r)},_openCourseDialog:async function(t){if(!this._courseDialog){this._courseDialog=await s.load({id:this.getView().getId(),name:"admin.view.CourseDialog",controller:this});this.getView().addDependent(this._courseDialog)}this._courseDialog.setModel(t,"dialogModel");if(this._departmentsModel){this._courseDialog.setModel(this._departmentsModel,"departments")}else{console.error("Departments model not loaded!")}if(this._instructorsModel){this._courseDialog.setModel(this._instructorsModel,"instructors")}else{console.error("Instructors model not loaded!")}this._courseDialog.open()},onCourseDepartmentChange:async function(t){const e=t.getParameter("selectedItem").getKey();const o=this._courseDialog.getModel("dialogModel");if(o.getProperty("/mode")==="create"){const t=await this._generateNextCourseCode(e);o.setProperty("/courseCode",t)}},_generateNextCourseCode:async function(t){try{const e=await window.AuthService.getToken();const o=await fetch(`/admin/Departments(${t})`,{headers:{Authorization:"Bearer "+e}});if(!o.ok){throw new Error("Failed to fetch department")}const n=await o.json();const s=n.departmentName;const r={"Computer Science":"CS","Business Administration":"BA",Mathematics:"MATH",Psychology:"PSY","Mechanical Engineering":"ME"};const a=r[s]||s.substring(0,3).toUpperCase();const i=await fetch(`/admin/Courses?$filter=department_ID eq ${t}&$orderby=courseCode desc&$top=1`,{headers:{Authorization:"Bearer "+e}});if(!i.ok){throw new Error("Failed to fetch courses")}const l=await i.json();if(l.value&&l.value.length>0){const t=l.value[0].courseCode;const e=t.match(/\d+$/);if(e){const t=parseInt(e[0])+1;return`${a}${t}`}}return`${a}101`}catch(t){console.error("Failed to generate course code:",t);return"COURSE101"}},onSaveCourse:async function(){const t=this._courseDialog.getModel("dialogModel");const e=t.getData();if(!e.courseCode||!e.courseName||!e.department_ID||!e.instructor_ID){n.error("Please fill in all required fields");return}try{const t=await window.AuthService.getToken();const n=e.mode==="create"?"/admin/Courses":`/admin/Courses(${e.ID})`;const s=e.mode==="create"?"POST":"PATCH";const r={courseCode:e.courseCode,courseName:e.courseName,description:e.description||"",ects:parseInt(e.ects),semester:e.semester,quota:parseInt(e.quota),enrolled:e.mode==="create"?0:parseInt(e.enrolled),isActive:e.isActive,department_ID:parseInt(e.department_ID),instructor_ID:parseInt(e.instructor_ID)};const a=await fetch(n,{method:s,headers:{Authorization:"Bearer "+t,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok){throw new Error(`HTTP ${a.status}: ${a.statusText}`)}o.show(e.mode==="create"?"Course created successfully":"Course updated successfully");this._courseDialog.close();this.getView().getModel().refresh()}catch(t){console.error("Failed to save course:",t);n.error("Failed to save course. Please try again.")}},onDeleteCourse:async function(t){const e=t.getSource().getParent().getParent();const o=e.getBindingContext("courses");const s=o.getObject();try{const t=await window.AuthService.getToken();const e=await fetch(`/admin/Enrollments?$filter=course_ID eq ${s.ID}&$expand=student`,{headers:{Authorization:"Bearer "+t}});if(!e.ok){throw new Error("Failed to check enrollments")}const o=await e.json();const r=o.value||[];let a=`Are you sure you want to delete course "${s.courseCode}: ${s.courseName}"?`;if(r.length>0){a+=`\n\n⚠️ CASCADE DELETE WARNING:\n\nThis will also delete ${r.length} enrollment(s):\n`;const t={};r.forEach(e=>{t[e.status]=(t[e.status]||0)+1});Object.keys(t).forEach(e=>{a+=`\n• ${t[e]} ${e} enrollment(s)`});a+=`\n\nAffected students:\n`;r.slice(0,5).forEach(t=>{a+=`\n• ${t.student?.firstName||""} ${t.student?.lastName||"Unknown"}`});if(r.length>5){a+=`\n... and ${r.length-5} more`}}n.warning(a,{title:"Confirm Delete",actions:[n.Action.DELETE,n.Action.CANCEL],emphasizedAction:n.Action.DELETE,onClose:async t=>{if(t===n.Action.DELETE){await this._deleteCourse(s.ID)}}})}catch(t){console.error("Error checking cascade effects:",t);n.error("Failed to check related records. Please try again.")}},_deleteCourse:async function(t){try{const e=await window.AuthService.getToken();const n=await fetch(`/admin/Courses(${t})`,{method:"DELETE",headers:{Authorization:"Bearer "+e}});if(!n.ok){throw new Error(`HTTP ${n.status}: ${n.statusText}`)}o.show("Course deleted successfully");this.getView().getModel().refresh()}catch(t){console.error("Failed to delete course:",t);n.error("Failed to delete course. Please try again.")}},onAddEnrollment:async function(){await this._loadStudentsForEnrollment();await this._loadCoursesForEnrollment();const t=new e({student_ID:null,course_ID:null,status:"ENROLLED",grade:null,studentEctsInfo:"Select a student to see ECTS information",courseCapacityInfo:"Select a course to see capacity information",validationMessage:"",validationType:"Information",showValidation:false,canEnroll:false,selectedStudentData:null,selectedCourseData:null});this._openAddEnrollmentDialog(t)},_loadStudentsForEnrollment:async function(){try{const t=await window.AuthService.getToken();const o=await fetch("/admin/Students?$expand=department",{headers:{Authorization:"Bearer "+t}});if(!o.ok){throw new Error("Failed to load students")}const n=await o.json();this._studentsModel=new e(n.value)}catch(t){console.error("Failed to load students:",t);n.error("Failed to load students")}},_loadCoursesForEnrollment:async function(){try{const t=await window.AuthService.getToken();const o=await fetch("/admin/Courses?$expand=department,instructor&$filter=isActive eq true",{headers:{Authorization:"Bearer "+t}});if(!o.ok){throw new Error("Failed to load courses")}const n=await o.json();this._coursesModel=new e(n.value)}catch(t){console.error("Failed to load courses:",t);n.error("Failed to load courses")}},_openAddEnrollmentDialog:async function(t){if(!this._addEnrollmentDialog){this._addEnrollmentDialog=await s.load({id:this.getView().getId(),name:"admin.view.AddEnrollmentDialog",controller:this});this.getView().addDependent(this._addEnrollmentDialog)}this._addEnrollmentDialog.setModel(t,"dialogModel");if(this._studentsModel){this._addEnrollmentDialog.setModel(this._studentsModel,"students")}if(this._coursesModel){this._addEnrollmentDialog.setModel(this._coursesModel,"courses")}this._addEnrollmentDialog.open()},onEnrollmentStudentChange:async function(t){const e=t.getParameter("selectedItem").getKey();const o=this._addEnrollmentDialog.getModel("dialogModel");if(!e){o.setProperty("/studentEctsInfo","Select a student to see ECTS information");o.setProperty("/selectedStudentData",null);this._validateEnrollment();return}try{const t=await window.AuthService.getToken();const n=await fetch(`/admin/Students(${e})`,{headers:{Authorization:"Bearer "+t}});if(!n.ok){throw new Error("Failed to fetch student details")}const s=await n.json();const r=await fetch(`/admin/Enrollments?$filter=student_ID eq ${e} and status eq 'ENROLLED'&$expand=course`,{headers:{Authorization:"Bearer "+t}});if(!r.ok){throw new Error("Failed to fetch student enrollments")}const a=await r.json();const i=a.value||[];const l=i.reduce((t,e)=>t+(e.course?.ects||0),0);const c=s.ectsLimit-l;o.setProperty("/studentEctsInfo",`ECTS: ${l} / ${s.ectsLimit} used (${c} available)`);o.setProperty("/selectedStudentData",{...s,usedEcts:l,availableEcts:c});this._validateEnrollment()}catch(t){console.error("Failed to load student info:",t);n.error("Failed to load student information")}},onEnrollmentCourseChange:async function(t){const e=t.getParameter("selectedItem").getKey();const o=this._addEnrollmentDialog.getModel("dialogModel");if(!e){o.setProperty("/courseCapacityInfo","Select a course to see capacity information");o.setProperty("/selectedCourseData",null);this._validateEnrollment();return}try{const t=await window.AuthService.getToken();const n=await fetch(`/admin/Courses(${e})`,{headers:{Authorization:"Bearer "+t}});if(!n.ok){throw new Error("Failed to fetch course details")}const s=await n.json();const r=s.quota-s.enrolled;o.setProperty("/courseCapacityInfo",`Capacity: ${s.enrolled} / ${s.quota} enrolled (${r} seats available)`);o.setProperty("/selectedCourseData",s);this._validateEnrollment()}catch(t){console.error("Failed to load course info:",t);n.error("Failed to load course information")}},_validateEnrollment:function(){const t=this._addEnrollmentDialog.getModel("dialogModel");const e=t.getProperty("/selectedStudentData");const o=t.getProperty("/selectedCourseData");t.setProperty("/showValidation",false);t.setProperty("/canEnroll",false);if(!e||!o){return}if(o.enrolled>=o.quota){t.setProperty("/validationMessage","Course is full! No seats available.");t.setProperty("/validationType","Error");t.setProperty("/showValidation",true);return}if(e.availableEcts<o.ects){t.setProperty("/validationMessage",`Student doesn't have enough ECTS! Needs ${o.ects} ECTS but only has ${e.availableEcts} available.`);t.setProperty("/validationType","Error");t.setProperty("/showValidation",true);return}this._checkDuplicateEnrollment(e.ID,o.ID)},_checkDuplicateEnrollment:async function(t,e){const o=this._addEnrollmentDialog.getModel("dialogModel");try{const n=await window.AuthService.getToken();const s=await fetch(`/admin/Enrollments?$filter=student_ID eq ${t} and course_ID eq ${e}`,{headers:{Authorization:"Bearer "+n}});if(!s.ok){throw new Error("Failed to check existing enrollments")}const r=await s.json();if(r.value&&r.value.length>0){o.setProperty("/validationMessage","Student is already enrolled in this course!");o.setProperty("/validationType","Error");o.setProperty("/showValidation",true);o.setProperty("/canEnroll",false)}else{o.setProperty("/validationMessage","All checks passed. Ready to enroll!");o.setProperty("/validationType","Success");o.setProperty("/showValidation",true);o.setProperty("/canEnroll",true)}}catch(t){console.error("Failed to check duplicate enrollment:",t)}},onEnrollmentGradeChange:function(t){const e=this._addEnrollmentDialog.getModel("dialogModel");const o=t.getParameter("value");if(!o||o.trim()===""){e.setProperty("/status","ENROLLED")}else{const t=parseFloat(o);if(isNaN(t)){e.setProperty("/status","ENROLLED");return}let n;if(t>=18){n="EXCELLENT"}else if(t>=16){n="VERY_GOOD"}else if(t>=14){n="GOOD"}else if(t>=12){n="SATISFACTORY"}else if(t>=10){n="PASSED"}else{n="FAILED"}e.setProperty("/status",n)}},onSaveNewEnrollment:async function(){const t=this._addEnrollmentDialog.getModel("dialogModel");const e=t.getData();if(!e.student_ID||!e.course_ID){n.error("Please select both student and course");return}if(!e.canEnroll){n.error("Cannot enroll. Please check validation messages.");return}let s="ENROLLED";let r=null;if(e.grade!==null&&e.grade!==undefined&&e.grade!==""){const t=parseFloat(e.grade);if(isNaN(t)){n.error("Grade must be a valid number");return}if(t<0||t>20){n.error("Grade must be between 0 and 20");return}r=t;if(t>=18){s="EXCELLENT"}else if(t>=16){s="VERY_GOOD"}else if(t>=14){s="GOOD"}else if(t>=12){s="SATISFACTORY"}else if(t>=10){s="PASSED"}else{s="FAILED"}}try{const t=await window.AuthService.getToken();const n={student_ID:parseInt(e.student_ID),course_ID:parseInt(e.course_ID),status:s,enrollmentDate:(new Date).toISOString()};if(r!==null){n.grade=r}const a=await fetch("/admin/Enrollments",{method:"POST",headers:{Authorization:"Bearer "+t,"Content-Type":"application/json"},body:JSON.stringify(n)});if(!a.ok){if(a.status===401){this._handleAuthError();return}else if(a.status===403){this._handleAuthorizationError();return}const t=await a.json().catch(()=>({}));throw new Error(t.error?.message||`HTTP ${a.status}: ${a.statusText}`)}o.show(`Student enrolled successfully with status: ${s}`);this._addEnrollmentDialog.close();this.getView().getModel().refresh();if(this._tabsLoaded.enrollments){this._loadEnrollments()}}catch(t){console.error("Failed to create enrollment:",t);n.error(`Failed to create enrollment: ${t.message}`)}},onEditEnrollment:async function(t){const o=t.getSource().getParent().getParent();const n=o.getBindingContext("enrollments");const s=n.getObject();const r=`${s.student?.firstName||""} ${s.student?.lastName||""}`.trim();const a=s.course?.courseName||"Unknown Course";const i=new e({title:"Edit Enrollment",ID:s.ID,studentName:r,courseName:a,status:s.status,grade:s.grade,course_ID:s.course_ID});this._openEnrollmentDialog(i)},_openEnrollmentDialog:async function(t){if(!this._enrollmentDialog){this._enrollmentDialog=await s.load({id:this.getView().getId(),name:"admin.view.EnrollmentDialog",controller:this});this.getView().addDependent(this._enrollmentDialog)}this._enrollmentDialog.setModel(t,"dialogModel");this._enrollmentDialog.open()},onSaveEnrollment:async function(){const t=this._enrollmentDialog.getModel("dialogModel");const e=t.getData();if(e.grade!==null&&e.grade!==undefined&&e.grade!==""){const t=parseFloat(e.grade);if(isNaN(t)){n.error("Grade must be a valid number");return}if(t<0||t>20){n.error("Grade must be between 0 and 20");return}}try{const t=await window.AuthService.getToken();const n={};if(e.grade!==null&&e.grade!==undefined&&e.grade!==""){n.grade=parseFloat(e.grade)}const s=await fetch(`/admin/Enrollments(${e.ID})`,{method:"PATCH",headers:{Authorization:"Bearer "+t,"Content-Type":"application/json"},body:JSON.stringify(n)});if(!s.ok){if(s.status===401){this._handleAuthError();return}else if(s.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${s.status}: ${s.statusText}`)}o.show("Enrollment updated successfully. Status automatically set based on grade.");this._enrollmentDialog.close();this.getView().getModel().refresh();if(this._tabsLoaded.enrollments){this._loadEnrollments()}}catch(t){console.error("Failed to save enrollment:",t);n.error("Failed to save enrollment. Please try again.")}},onDeleteEnrollment:async function(t){const e=t.getSource().getParent().getParent();const o=e.getBindingContext("enrollments");const s=o.getObject();const r=`${s.student?.firstName||""} ${s.student?.lastName||"Unknown"}`;const a=s.course?.courseName||"Unknown Course";n.warning(`Are you sure you want to delete this enrollment?\n\nStudent: ${r}\nCourse: ${a}\nStatus: ${s.status}`,{title:"Confirm Delete",actions:[n.Action.DELETE,n.Action.CANCEL],emphasizedAction:n.Action.DELETE,onClose:async t=>{if(t===n.Action.DELETE){await this._deleteEnrollment(s.ID)}}})},_deleteEnrollment:async function(t){try{const e=await window.AuthService.getToken();const n=await fetch(`/admin/Enrollments(${t})`,{method:"DELETE",headers:{Authorization:"Bearer "+e}});if(!n.ok){throw new Error(`HTTP ${n.status}: ${n.statusText}`)}o.show("Enrollment deleted successfully");this.getView().getModel().refresh();if(this._tabsLoaded.enrollments){this._loadEnrollments()}if(this._tabsLoaded.courses){this._loadCourses()}}catch(t){console.error("Failed to delete enrollment:",t);n.error("Failed to delete enrollment. Please try again.")}},formatStatusState:function(t){switch(t){case"ENROLLED":return"Information";case"EXCELLENT":return"Success";case"VERY_GOOD":return"Success";case"GOOD":return"Success";case"SATISFACTORY":return"Warning";case"PASSED":return"Warning";case"FAILED":return"Error";case"COMPLETED":return"Success";case"DROPPED":return"None";default:return"None"}},formatActiveText:function(t){return t?"Active":"Inactive"},formatActiveState:function(t){return t?"Success":"None"},_loadDepartments:async function(){if(this._departmentsModel){return}try{const t=await window.AuthService.getToken();const o=await fetch("/admin/Departments",{headers:{Authorization:"Bearer "+t}});if(!o.ok){throw new Error("Failed to load departments")}const n=await o.json();this._departmentsModel=new e(n.value)}catch(t){console.error("Failed to load departments:",t);n.error("Failed to load departments")}},_loadInstructorsForDropdown:async function(){if(this._instructorsModel){return}try{const t=await window.AuthService.getToken();const o=await fetch("/admin/Instructors",{headers:{Authorization:"Bearer "+t}});if(!o.ok){throw new Error("Failed to load instructors")}const n=await o.json();this._instructorsModel=new e(n.value)}catch(t){console.error("Failed to load instructors:",t);n.error("Failed to load instructors")}},onCancelDialog:function(){if(this._studentDialog&&this._studentDialog.isOpen()){this._studentDialog.close()}if(this._instructorDialog&&this._instructorDialog.isOpen()){this._instructorDialog.close()}if(this._courseDialog&&this._courseDialog.isOpen()){this._courseDialog.close()}if(this._enrollmentDialog&&this._enrollmentDialog.isOpen()){this._enrollmentDialog.close()}if(this._addEnrollmentDialog&&this._addEnrollmentDialog.isOpen()){this._addEnrollmentDialog.close()}},_handleError:function(t,e){console.error(`[${e}] Error:`,t);o.show(`Failed to ${e}. Please try again.`)},_handleAuthError:function(){n.error("Your session has expired. Please log in again.",{onClose:async function(){await window.AuthService.login()}})},_handleAuthorizationError:function(){n.error("You don't have permission to access this resource.",{onClose:function(){window.location.href="../../launchpad.html"}})}})});
//# sourceMappingURL=Main.controller.js.map