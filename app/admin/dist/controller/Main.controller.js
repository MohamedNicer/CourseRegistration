sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/Fragment"],function(t,e,s,o,n){"use strict";return t.extend("admin.controller.Main",{_getAuthHeaders:async function(){const t=await window.AuthService.getToken();const e=await window.AuthService.getUser();return{Authorization:"Bearer "+t,"X-User-Email":e.email,"X-User-Role":e["https://courseregistration.com/role"]||e["custom:role"]||e.role||"admin"}},onInit:function(){console.log("Admin Main Controller initialized");const t=new e({email:"",name:""});this.getView().setModel(t,"profile");const s=new e({students:[]});this.getView().setModel(s,"students");const o=new e({instructors:[]});this.getView().setModel(o,"instructors");const n=new e({courses:[]});this.getView().setModel(n,"courses");const r=new e({enrollments:[]});this.getView().setModel(r,"enrollments");this._tabsLoaded={students:false,instructors:false,courses:false,enrollments:false};this._charts={};this._chartData={};setTimeout(()=>{this._loadAdminProfile();this._loadStudents();this._tabsLoaded.students=true},500)},onAfterRendering:function(){console.log("Admin view rendered, checking for pending charts...");if(this._chartData.students){this._renderStudentChartsNow(this._chartData.students)}if(this._chartData.instructors){this._renderInstructorChartsNow(this._chartData.instructors)}if(this._chartData.courses){this._renderCourseChartsNow(this._chartData.courses)}if(this._chartData.enrollments){this._renderEnrollmentChartsNow(this._chartData.enrollments)}},onTabSelect:function(t){const e=t.getParameter("key");console.log("Tab selected:",e,"Already loaded:",this._tabsLoaded[e]);if(e==="students"&&!this._tabsLoaded.students){this._loadStudents();this._tabsLoaded.students=true}else if(e==="instructors"&&!this._tabsLoaded.instructors){console.log("Loading instructors tab for the first time");this._loadInstructors();this._tabsLoaded.instructors=true}else if(e==="courses"&&!this._tabsLoaded.courses){this._loadCourses();this._tabsLoaded.courses=true}else if(e==="enrollments"&&!this._tabsLoaded.enrollments){this._loadEnrollments();this._tabsLoaded.enrollments=true}},onNavBack:function(){window.location.href="/launchpad.html"},onLogout:async function(){if(typeof window.AuthService!=="undefined"){await window.AuthService.logout()}else{window.location.href="../../launchpad.html"}},_loadAdminProfile:async function(){try{if(typeof window.AuthService==="undefined"){console.error("AuthService not available");s.show("Authentication service not available");return}const t=await window.AuthService.getUser();console.log("Admin user:",t);const e=this.getView().getModel("profile");e.setProperty("/email",t.email||"");e.setProperty("/name",t.name||t.nickname||"Admin User")}catch(t){console.error("Failed to load admin profile:",t);this._handleError(t,"load admin profile")}},_loadStudents:async function(){const t=this.byId("studentTable");try{console.log("Loading students...");if(t){t.setBusy(true)}const e=await window.AuthService.getToken();const s=await window.AuthService.getUser();const o=await fetch("/admin/Students?$expand=department",{headers:{Authorization:"Bearer "+e,"X-User-Email":s.email,"X-User-Role":s["https://courseregistration.com/role"]||s["custom:role"]||s.role||"admin"}});if(!o.ok){if(o.status===401){this._handleAuthError();return}else if(o.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${o.status}: ${o.statusText}`)}const n=await o.json();console.log("Students loaded:",n);const r=this.getView().getModel("students");r.setProperty("/students",n.value||[]);this._renderStudentCharts(n.value)}catch(t){console.error("Failed to load students:",t);this._handleError(t,"load students")}finally{if(t){t.setBusy(false)}}},_loadInstructors:async function(){console.log("_loadInstructors called");const t=this.byId("instructorTable");console.log("Instructor table found:",!!t);try{console.log("Loading instructors...");if(t){t.setBusy(true)}const e=await window.AuthService.getToken();const s=await window.AuthService.getUser();const o=await fetch("/admin/Instructors?$expand=department",{headers:{Authorization:"Bearer "+e,"X-User-Email":s.email,"X-User-Role":s["https://courseregistration.com/role"]||s["custom:role"]||s.role||"admin"}});if(!o.ok){if(o.status===401){this._handleAuthError();return}else if(o.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${o.status}: ${o.statusText}`)}const n=await o.json();console.log("Instructors loaded:",n);const r=this.getView().getModel("instructors");r.setProperty("/instructors",n.value||[]);this._renderInstructorCharts(n.value)}catch(t){console.error("Failed to load instructors:",t);this._handleError(t,"load instructors")}finally{if(t){t.setBusy(false)}}},_loadCourses:async function(){const t=this.byId("courseTable");try{console.log("Loading courses...");if(t){t.setBusy(true)}const e=await window.AuthService.getToken();const s=await window.AuthService.getUser();const o=await fetch("/admin/Courses?$expand=department,instructor",{headers:{Authorization:"Bearer "+e,"X-User-Email":s.email,"X-User-Role":s["https://courseregistration.com/role"]||s["custom:role"]||s.role||"admin"}});if(!o.ok){if(o.status===401){this._handleAuthError();return}else if(o.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${o.status}: ${o.statusText}`)}const n=await o.json();console.log("Courses loaded:",n);const r=this.getView().getModel("courses");r.setProperty("/courses",n.value||[]);this._renderCourseCharts(n.value)}catch(t){console.error("Failed to load courses:",t);this._handleError(t,"load courses")}finally{if(t){t.setBusy(false)}}},_loadEnrollments:async function(){const t=this.byId("enrollmentTable");try{console.log("Loading enrollments...");if(t){t.setBusy(true)}const e=await window.AuthService.getToken();const s=await window.AuthService.getUser();const o=await fetch("/admin/Enrollments?$expand=student,course",{headers:{Authorization:"Bearer "+e,"X-User-Email":s.email,"X-User-Role":s["https://courseregistration.com/role"]||s["custom:role"]||s.role||"admin"}});if(!o.ok){if(o.status===401){this._handleAuthError();return}else if(o.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${o.status}: ${o.statusText}`)}const n=await o.json();console.log("Enrollments loaded:",n);const r=this.getView().getModel("enrollments");r.setProperty("/enrollments",n.value||[]);this._renderEnrollmentCharts(n.value)}catch(t){console.error("Failed to load enrollments:",t);this._handleError(t,"load enrollments")}finally{if(t){t.setBusy(false)}}},_renderStudentCharts:function(t){this._chartData.students=t;setTimeout(()=>{this._renderStudentChartsNow(t)},800)},_renderStudentChartsNow:function(t){const e={};t.forEach(t=>{const s=t.department?.departmentName||"Unknown";e[s]=(e[s]||0)+1});this._createPieChart("studentDeptChart","Students by Department",e);const s={"0-30":0,"31-60":0,"61-90":0,"90+":0};t.forEach(t=>{const e=t.ectsLimit||0;if(e<=30)s["0-30"]++;else if(e<=60)s["31-60"]++;else if(e<=90)s["61-90"]++;else s["90+"]++});this._createBarChart("studentStatsChart","ECTS Limit Distribution",s)},_renderInstructorCharts:function(t){this._chartData.instructors=t;setTimeout(()=>{this._renderInstructorChartsNow(t)},1e3)},_renderInstructorChartsNow:function(t){console.log("Rendering instructor charts with",t.length,"instructors");const e={};t.forEach(t=>{const s=t.department?.departmentName||"Unknown";e[s]=(e[s]||0)+1});console.log("Instructor dept counts:",e);this._createPieChart("instructorDeptChart","Instructors by Department",e);const s={};t.forEach(t=>{const e=t.department?.faculty||"Unknown";s[e]=(s[e]||0)+1});console.log("Instructor faculty counts:",s);this._createBarChart("instructorStatsChart","Instructors by Faculty",s)},_renderCourseCharts:function(t){this._chartData.courses=t;setTimeout(()=>{this._renderCourseChartsNow(t)},800)},_renderCourseChartsNow:function(t){const e={};t.forEach(t=>{const s=t.department?.departmentName||"Unknown";e[s]=(e[s]||0)+1});this._createPieChart("courseDeptChart","Courses by Department",e);const s={"Full (100%)":0,"High (75-99%)":0,"Medium (50-74%)":0,"Low (<50%)":0,Empty:0};t.forEach(t=>{const e=t.quota>0?t.enrolled/t.quota*100:0;if(e>=100)s["Full (100%)"]++;else if(e>=75)s["High (75-99%)"]++;else if(e>=50)s["Medium (50-74%)"]++;else if(e>0)s["Low (<50%)"]++;else s["Empty"]++});this._createBarChart("courseCapacityChart","Course Capacity Utilization",s)},_renderEnrollmentCharts:function(t){this._chartData.enrollments=t;setTimeout(()=>{this._renderEnrollmentChartsNow(t)},800)},_renderEnrollmentChartsNow:function(t){const e={};t.forEach(t=>{const s=t.status||"Unknown";e[s]=(e[s]||0)+1});const s={ENROLLED:"#0070F2",EXCELLENT:"#107E3E",VERY_GOOD:"#2B7D2B",GOOD:"#10B981",SATISFACTORY:"#F59E0B",PASSED:"#E9730C",FAILED:"#D04343",COMPLETED:"#107E3E",DROPPED:"#5B738B"};const o=Object.keys(e).map(t=>s[t]||"#999999");this._createPieChartWithColors("enrollmentStatusChart","Enrollments by Status",e,o);const n={"A (18-20)":0,"B (15-17.9)":0,"C (12-14.9)":0,"D (10-11.9)":0,"F (<10)":0,"No Grade":0};t.forEach(t=>{const e=t.grade;if(e===null||e===undefined){n["No Grade"]++}else if(e>=18)n["A (18-20)"]++;else if(e>=15)n["B (15-17.9)"]++;else if(e>=12)n["C (12-14.9)"]++;else if(e>=10)n["D (10-11.9)"]++;else n["F (<10)"]++});this._createBarChart("enrollmentTrendChart","Grade Distribution",n)},_createPieChart:function(t,e,s){const o=document.getElementById(t);if(!o){console.warn(`Canvas element ${t} not found`);return}if(this._charts[t]){this._charts[t].destroy()}const n=o.getContext("2d");this._charts[t]=new Chart(n,{type:"pie",data:{labels:Object.keys(s),datasets:[{data:Object.values(s),backgroundColor:["#0070F2","#E9730C","#107E3E","#C0399F","#5B738B","#D04343","#2B7D2B","#8B5CF6","#F59E0B","#10B981"]}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:e,font:{size:14}},legend:{position:"bottom"}}}})},_createPieChartWithColors:function(t,e,s,o){const n=document.getElementById(t);if(!n){console.warn(`Canvas element ${t} not found`);return}if(this._charts[t]){this._charts[t].destroy()}const r=n.getContext("2d");this._charts[t]=new Chart(r,{type:"pie",data:{labels:Object.keys(s),datasets:[{data:Object.values(s),backgroundColor:o}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:e,font:{size:14}},legend:{position:"bottom"}}}})},_createBarChart:function(t,e,s){const o=document.getElementById(t);if(!o){console.warn(`Canvas element ${t} not found`);return}if(this._charts[t]){this._charts[t].destroy()}const n=o.getContext("2d");this._charts[t]=new Chart(n,{type:"bar",data:{labels:Object.keys(s),datasets:[{label:"Count",data:Object.values(s),backgroundColor:"#0070F2"}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:e,font:{size:14}},legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}})},onAddStudent:async function(){await this._loadDepartments();const t=await this._generateNextStudentNumber();const s=new e({title:"Add New Student",mode:"create",studentNumber:t,firstName:"",lastName:"",email:"",ectsLimit:60,department_ID:null});this._openStudentDialog(s)},_generateNextStudentNumber:async function(){try{const t=await this._getAuthHeaders();const e=await fetch("/admin/Students?$orderby=studentNumber desc&$top=1",{headers:t});if(!e.ok){throw new Error("Failed to fetch students")}const s=await e.json();if(s.value&&s.value.length>0){const t=s.value[0].studentNumber;const e=t.match(/STU(\d+)/);if(e){const t=parseInt(e[1])+1;return`STU${String(t).padStart(3,"0")}`}}return"STU001"}catch(t){console.error("Failed to generate student number:",t);return"STU001"}},onEditStudent:async function(t){const s=t.getSource().getParent().getParent();const o=s.getBindingContext("students");const n=o.getObject();await this._loadDepartments();const r=new e({title:"Edit Student",mode:"edit",ID:n.ID,studentNumber:n.studentNumber,firstName:n.firstName,lastName:n.lastName,email:n.email,ectsLimit:n.ectsLimit,department_ID:n.department_ID});this._openStudentDialog(r)},_openStudentDialog:async function(t){if(!this._studentDialog){this._studentDialog=await n.load({id:this.getView().getId(),name:"admin.view.StudentDialog",controller:this});this.getView().addDependent(this._studentDialog)}this._studentDialog.setModel(t,"dialogModel");if(this._departmentsModel){this._studentDialog.setModel(this._departmentsModel,"departments")}else{console.error("Departments model not loaded!")}this._studentDialog.open()},onSaveStudent:async function(){const t=this._studentDialog.getModel("dialogModel");const e=t.getData();if(!e.studentNumber||!e.firstName||!e.lastName||!e.email||!e.department_ID){o.error("Please fill in all required fields");return}try{const t=await this._getAuthHeaders();const o=e.mode==="create"?"/admin/Students":`/admin/Students(${e.ID})`;const n=e.mode==="create"?"POST":"PATCH";const r={studentNumber:e.studentNumber,firstName:e.firstName,lastName:e.lastName,email:e.email,ectsLimit:parseInt(e.ectsLimit),department_ID:parseInt(e.department_ID)};const a=await fetch(o,{method:n,headers:{...t,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok){throw new Error(`HTTP ${a.status}: ${a.statusText}`)}s.show(e.mode==="create"?"Student created successfully":"Student updated successfully");this._studentDialog.close();this.getView().getModel().refresh()}catch(t){console.error("Failed to save student:",t);o.error("Failed to save student. Please try again.")}},onDeleteStudent:async function(t){const e=t.getSource().getParent().getParent();const s=e.getBindingContext("students");const n=s.getObject();try{const t=await this._getAuthHeaders();const e=await fetch(`/admin/Enrollments?$filter=student_ID eq ${n.ID}&$expand=course`,{headers:t});if(!e.ok){throw new Error("Failed to check enrollments")}const s=await e.json();const r=s.value||[];let a=`Are you sure you want to delete student "${n.firstName} ${n.lastName}"?`;if(r.length>0){a+=`\n\n⚠️ CASCADE DELETE WARNING:\n\nThis will also delete ${r.length} enrollment(s):\n`;r.slice(0,5).forEach(t=>{a+=`\n• ${t.course?.courseName||"Unknown Course"} (${t.status})`});if(r.length>5){a+=`\n... and ${r.length-5} more`}}o.warning(a,{title:"Confirm Delete",actions:[o.Action.DELETE,o.Action.CANCEL],emphasizedAction:o.Action.DELETE,onClose:async t=>{if(t===o.Action.DELETE){await this._deleteStudent(n.ID)}}})}catch(t){console.error("Error checking cascade effects:",t);o.error("Failed to check related records. Please try again.")}},_deleteStudent:async function(t){try{const e=await this._getAuthHeaders();const o=await fetch(`/admin/Students(${t})`,{method:"DELETE",headers:e});if(!o.ok){throw new Error(`HTTP ${o.status}: ${o.statusText}`)}s.show("Student deleted successfully");this.getView().getModel().refresh()}catch(t){console.error("Failed to delete student:",t);o.error("Failed to delete student. Please try again.")}},onAddInstructor:async function(){await this._loadDepartments();const t=await this._generateNextInstructorId();const s=new e({title:"Add New Instructor",mode:"create",instructorId:t,firstName:"",lastName:"",email:"",department_ID:null});this._openInstructorDialog(s)},_generateNextInstructorId:async function(){try{const t=await this._getAuthHeaders();const e=await fetch("/admin/Instructors?$orderby=instructorId desc&$top=1",{headers:t});if(!e.ok){throw new Error("Failed to fetch instructors")}const s=await e.json();if(s.value&&s.value.length>0){const t=s.value[0].instructorId;const e=t.match(/INS(\d+)/);if(e){const t=parseInt(e[1])+1;return`INS${String(t).padStart(3,"0")}`}}return"INS001"}catch(t){console.error("Failed to generate instructor ID:",t);return"INS001"}},onEditInstructor:async function(t){const s=t.getSource().getParent().getParent();const o=s.getBindingContext("instructors");const n=o.getObject();await this._loadDepartments();const r=new e({title:"Edit Instructor",mode:"edit",ID:n.ID,instructorId:n.instructorId,firstName:n.firstName,lastName:n.lastName,email:n.email,department_ID:n.department_ID});this._openInstructorDialog(r)},_openInstructorDialog:async function(t){if(!this._instructorDialog){this._instructorDialog=await n.load({id:this.getView().getId(),name:"admin.view.InstructorDialog",controller:this});this.getView().addDependent(this._instructorDialog)}this._instructorDialog.setModel(t,"dialogModel");if(this._departmentsModel){this._instructorDialog.setModel(this._departmentsModel,"departments")}else{console.error("Departments model not loaded!")}this._instructorDialog.open()},onSaveInstructor:async function(){const t=this._instructorDialog.getModel("dialogModel");const e=t.getData();if(!e.instructorId||!e.firstName||!e.lastName||!e.email||!e.department_ID){o.error("Please fill in all required fields");return}try{const t=await this._getAuthHeaders();const o=e.mode==="create"?"/admin/Instructors":`/admin/Instructors(${e.ID})`;const n=e.mode==="create"?"POST":"PATCH";const r={instructorId:e.instructorId,firstName:e.firstName,lastName:e.lastName,email:e.email,department_ID:parseInt(e.department_ID)};const a=await fetch(o,{method:n,headers:{...t,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok){throw new Error(`HTTP ${a.status}: ${a.statusText}`)}s.show(e.mode==="create"?"Instructor created successfully":"Instructor updated successfully");this._instructorDialog.close();this.getView().getModel().refresh()}catch(t){console.error("Failed to save instructor:",t);o.error("Failed to save instructor. Please try again.")}},onDeleteInstructor:async function(t){const e=t.getSource().getParent().getParent();const s=e.getBindingContext("instructors");const n=s.getObject();try{const t=await this._getAuthHeaders();const e=await fetch(`/admin/Courses?$filter=instructor_ID eq ${n.ID}`,{headers:t});if(!e.ok){throw new Error("Failed to check courses")}const s=await e.json();const r=s.value||[];let a=`Are you sure you want to delete instructor "${n.firstName} ${n.lastName}"?`;if(r.length>0){a+=`\n\n⚠️ CASCADE DELETE WARNING:\n\nThis instructor teaches ${r.length} course(s):\n`;r.slice(0,5).forEach(t=>{a+=`\n• ${t.courseCode}: ${t.courseName}`});if(r.length>5){a+=`\n... and ${r.length-5} more`}a+=`\n\nThese courses will have no instructor assigned.`}o.warning(a,{title:"Confirm Delete",actions:[o.Action.DELETE,o.Action.CANCEL],emphasizedAction:o.Action.DELETE,onClose:async t=>{if(t===o.Action.DELETE){await this._deleteInstructor(n.ID)}}})}catch(t){console.error("Error checking cascade effects:",t);o.error("Failed to check related records. Please try again.")}},_deleteInstructor:async function(t){try{const e=await this._getAuthHeaders();const o=await fetch(`/admin/Instructors(${t})`,{method:"DELETE",headers:e});if(!o.ok){throw new Error(`HTTP ${o.status}: ${o.statusText}`)}s.show("Instructor deleted successfully");this.getView().getModel().refresh()}catch(t){console.error("Failed to delete instructor:",t);o.error("Failed to delete instructor. Please try again.")}},onAddCourse:async function(){await this._loadDepartments();await this._loadInstructorsForDropdown();const t=new e({title:"Add New Course",mode:"create",courseCode:"",courseName:"",description:"",ects:6,semester:"Fall 2025",quota:30,enrolled:0,isActive:true,department_ID:null,instructor_ID:null});this._openCourseDialog(t)},onEditCourse:async function(t){const s=t.getSource().getParent().getParent();const o=s.getBindingContext("courses");const n=o.getObject();await this._loadDepartments();await this._loadInstructorsForDropdown();const r=new e({title:"Edit Course",mode:"edit",ID:n.ID,courseCode:n.courseCode,courseName:n.courseName,description:n.description,ects:n.ects,semester:n.semester,quota:n.quota,enrolled:n.enrolled,isActive:n.isActive,department_ID:n.department_ID,instructor_ID:n.instructor_ID});this._openCourseDialog(r)},_openCourseDialog:async function(t){if(!this._courseDialog){this._courseDialog=await n.load({id:this.getView().getId(),name:"admin.view.CourseDialog",controller:this});this.getView().addDependent(this._courseDialog)}this._courseDialog.setModel(t,"dialogModel");if(this._departmentsModel){this._courseDialog.setModel(this._departmentsModel,"departments")}else{console.error("Departments model not loaded!")}if(this._instructorsModel){this._courseDialog.setModel(this._instructorsModel,"instructors")}else{console.error("Instructors model not loaded!")}this._courseDialog.open()},onCourseDepartmentChange:async function(t){const e=t.getParameter("selectedItem").getKey();const s=this._courseDialog.getModel("dialogModel");if(s.getProperty("/mode")==="create"){const t=await this._generateNextCourseCode(e);s.setProperty("/courseCode",t)}},_generateNextCourseCode:async function(t){try{const e=await this._getAuthHeaders();const s=await fetch(`/admin/Departments(${t})`,{headers:e});if(!s.ok){throw new Error("Failed to fetch department")}const o=await s.json();const n=o.departmentName;const r={"Computer Science":"CS","Business Administration":"BA",Mathematics:"MATH",Psychology:"PSY","Mechanical Engineering":"ME"};const a=r[n]||n.substring(0,3).toUpperCase();const i=await fetch(`/admin/Courses?$filter=department_ID eq ${t}&$orderby=courseCode desc&$top=1`,{headers:e});if(!i.ok){throw new Error("Failed to fetch courses")}const l=await i.json();if(l.value&&l.value.length>0){const t=l.value[0].courseCode;const e=t.match(/\d+$/);if(e){const t=parseInt(e[0])+1;return`${a}${t}`}}return`${a}101`}catch(t){console.error("Failed to generate course code:",t);return"COURSE101"}},onSaveCourse:async function(){const t=this._courseDialog.getModel("dialogModel");const e=t.getData();if(!e.courseCode||!e.courseName||!e.department_ID||!e.instructor_ID){o.error("Please fill in all required fields");return}try{const t=await this._getAuthHeaders();const o=e.mode==="create"?"/admin/Courses":`/admin/Courses(${e.ID})`;const n=e.mode==="create"?"POST":"PATCH";const r={courseCode:e.courseCode,courseName:e.courseName,description:e.description||"",ects:parseInt(e.ects),semester:e.semester,quota:parseInt(e.quota),enrolled:e.mode==="create"?0:parseInt(e.enrolled),isActive:e.isActive,department_ID:parseInt(e.department_ID),instructor_ID:parseInt(e.instructor_ID)};const a=await fetch(o,{method:n,headers:{...t,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok){throw new Error(`HTTP ${a.status}: ${a.statusText}`)}s.show(e.mode==="create"?"Course created successfully":"Course updated successfully");this._courseDialog.close();this.getView().getModel().refresh()}catch(t){console.error("Failed to save course:",t);o.error("Failed to save course. Please try again.")}},onDeleteCourse:async function(t){const e=t.getSource().getParent().getParent();const s=e.getBindingContext("courses");const n=s.getObject();try{const t=await this._getAuthHeaders();const e=await fetch(`/admin/Enrollments?$filter=course_ID eq ${n.ID}&$expand=student`,{headers:t});if(!e.ok){throw new Error("Failed to check enrollments")}const s=await e.json();const r=s.value||[];let a=`Are you sure you want to delete course "${n.courseCode}: ${n.courseName}"?`;if(r.length>0){a+=`\n\n⚠️ CASCADE DELETE WARNING:\n\nThis will also delete ${r.length} enrollment(s):\n`;const t={};r.forEach(e=>{t[e.status]=(t[e.status]||0)+1});Object.keys(t).forEach(e=>{a+=`\n• ${t[e]} ${e} enrollment(s)`});a+=`\n\nAffected students:\n`;r.slice(0,5).forEach(t=>{a+=`\n• ${t.student?.firstName||""} ${t.student?.lastName||"Unknown"}`});if(r.length>5){a+=`\n... and ${r.length-5} more`}}o.warning(a,{title:"Confirm Delete",actions:[o.Action.DELETE,o.Action.CANCEL],emphasizedAction:o.Action.DELETE,onClose:async t=>{if(t===o.Action.DELETE){await this._deleteCourse(n.ID)}}})}catch(t){console.error("Error checking cascade effects:",t);o.error("Failed to check related records. Please try again.")}},_deleteCourse:async function(t){try{const e=await this._getAuthHeaders();const o=await fetch(`/admin/Courses(${t})`,{method:"DELETE",headers:e});if(!o.ok){throw new Error(`HTTP ${o.status}: ${o.statusText}`)}s.show("Course deleted successfully");this.getView().getModel().refresh()}catch(t){console.error("Failed to delete course:",t);o.error("Failed to delete course. Please try again.")}},onAddEnrollment:async function(){await this._loadStudentsForEnrollment();await this._loadCoursesForEnrollment();const t=new e({student_ID:null,course_ID:null,status:"ENROLLED",grade:null,studentEctsInfo:"Select a student to see ECTS information",courseCapacityInfo:"Select a course to see capacity information",validationMessage:"",validationType:"Information",showValidation:false,canEnroll:false,selectedStudentData:null,selectedCourseData:null});this._openAddEnrollmentDialog(t)},_loadStudentsForEnrollment:async function(){try{const t=await this._getAuthHeaders();const s=await fetch("/admin/Students?$expand=department",{headers:t});if(!s.ok){throw new Error("Failed to load students")}const o=await s.json();this._studentsModel=new e(o.value)}catch(t){console.error("Failed to load students:",t);o.error("Failed to load students")}},_loadCoursesForEnrollment:async function(){try{const t=await this._getAuthHeaders();const s=await fetch("/admin/Courses?$expand=department,instructor&$filter=isActive eq true",{headers:t});if(!s.ok){throw new Error("Failed to load courses")}const o=await s.json();this._coursesModel=new e(o.value)}catch(t){console.error("Failed to load courses:",t);o.error("Failed to load courses")}},_openAddEnrollmentDialog:async function(t){if(!this._addEnrollmentDialog){this._addEnrollmentDialog=await n.load({id:this.getView().getId(),name:"admin.view.AddEnrollmentDialog",controller:this});this.getView().addDependent(this._addEnrollmentDialog)}this._addEnrollmentDialog.setModel(t,"dialogModel");if(this._studentsModel){this._addEnrollmentDialog.setModel(this._studentsModel,"students")}if(this._coursesModel){this._addEnrollmentDialog.setModel(this._coursesModel,"courses")}this._addEnrollmentDialog.open()},onEnrollmentStudentChange:async function(t){const e=t.getParameter("selectedItem").getKey();const s=this._addEnrollmentDialog.getModel("dialogModel");if(!e){s.setProperty("/studentEctsInfo","Select a student to see ECTS information");s.setProperty("/selectedStudentData",null);this._validateEnrollment();return}try{const t=await this._getAuthHeaders();const o=await fetch(`/admin/Students(${e})`,{headers:t});if(!o.ok){throw new Error("Failed to fetch student details")}const n=await o.json();const r=await fetch(`/admin/Enrollments?$filter=student_ID eq ${e} and status eq 'ENROLLED'&$expand=course`,{headers:t});if(!r.ok){throw new Error("Failed to fetch student enrollments")}const a=await r.json();const i=a.value||[];const l=i.reduce((t,e)=>t+(e.course?.ects||0),0);const c=n.ectsLimit-l;s.setProperty("/studentEctsInfo",`ECTS: ${l} / ${n.ectsLimit} used (${c} available)`);s.setProperty("/selectedStudentData",{...n,usedEcts:l,availableEcts:c});this._validateEnrollment()}catch(t){console.error("Failed to load student info:",t);o.error("Failed to load student information")}},onEnrollmentCourseChange:async function(t){const e=t.getParameter("selectedItem").getKey();const s=this._addEnrollmentDialog.getModel("dialogModel");if(!e){s.setProperty("/courseCapacityInfo","Select a course to see capacity information");s.setProperty("/selectedCourseData",null);this._validateEnrollment();return}try{const t=await this._getAuthHeaders();const o=await fetch(`/admin/Courses(${e})`,{headers:t});if(!o.ok){throw new Error("Failed to fetch course details")}const n=await o.json();const r=n.quota-n.enrolled;s.setProperty("/courseCapacityInfo",`Capacity: ${n.enrolled} / ${n.quota} enrolled (${r} seats available)`);s.setProperty("/selectedCourseData",n);this._validateEnrollment()}catch(t){console.error("Failed to load course info:",t);o.error("Failed to load course information")}},_validateEnrollment:function(){const t=this._addEnrollmentDialog.getModel("dialogModel");const e=t.getProperty("/selectedStudentData");const s=t.getProperty("/selectedCourseData");t.setProperty("/showValidation",false);t.setProperty("/canEnroll",false);if(!e||!s){return}if(s.enrolled>=s.quota){t.setProperty("/validationMessage","Course is full! No seats available.");t.setProperty("/validationType","Error");t.setProperty("/showValidation",true);return}if(e.availableEcts<s.ects){t.setProperty("/validationMessage",`Student doesn't have enough ECTS! Needs ${s.ects} ECTS but only has ${e.availableEcts} available.`);t.setProperty("/validationType","Error");t.setProperty("/showValidation",true);return}this._checkDuplicateEnrollment(e.ID,s.ID)},_checkDuplicateEnrollment:async function(t,e){const s=this._addEnrollmentDialog.getModel("dialogModel");try{const o=await this._getAuthHeaders();const n=await fetch(`/admin/Enrollments?$filter=student_ID eq ${t} and course_ID eq ${e}`,{headers:o});if(!n.ok){throw new Error("Failed to check existing enrollments")}const r=await n.json();if(r.value&&r.value.length>0){s.setProperty("/validationMessage","Student is already enrolled in this course!");s.setProperty("/validationType","Error");s.setProperty("/showValidation",true);s.setProperty("/canEnroll",false)}else{s.setProperty("/validationMessage","All checks passed. Ready to enroll!");s.setProperty("/validationType","Success");s.setProperty("/showValidation",true);s.setProperty("/canEnroll",true)}}catch(t){console.error("Failed to check duplicate enrollment:",t)}},onEnrollmentGradeChange:function(t){const e=this._addEnrollmentDialog.getModel("dialogModel");const s=t.getParameter("value");if(!s||s.trim()===""){e.setProperty("/status","ENROLLED")}else{const t=parseFloat(s);if(isNaN(t)){e.setProperty("/status","ENROLLED");return}let o;if(t>=18){o="EXCELLENT"}else if(t>=16){o="VERY_GOOD"}else if(t>=14){o="GOOD"}else if(t>=12){o="SATISFACTORY"}else if(t>=10){o="PASSED"}else{o="FAILED"}e.setProperty("/status",o)}},onSaveNewEnrollment:async function(){const t=this._addEnrollmentDialog.getModel("dialogModel");const e=t.getData();if(!e.student_ID||!e.course_ID){o.error("Please select both student and course");return}if(!e.canEnroll){o.error("Cannot enroll. Please check validation messages.");return}let n="ENROLLED";let r=null;if(e.grade!==null&&e.grade!==undefined&&e.grade!==""){const t=parseFloat(e.grade);if(isNaN(t)){o.error("Grade must be a valid number");return}if(t<0||t>20){o.error("Grade must be between 0 and 20");return}r=t;if(t>=18){n="EXCELLENT"}else if(t>=16){n="VERY_GOOD"}else if(t>=14){n="GOOD"}else if(t>=12){n="SATISFACTORY"}else if(t>=10){n="PASSED"}else{n="FAILED"}}try{const t=await this._getAuthHeaders();const o={student_ID:parseInt(e.student_ID),course_ID:parseInt(e.course_ID),status:n,enrollmentDate:(new Date).toISOString()};if(r!==null){o.grade=r}const a=await fetch("/admin/Enrollments",{method:"POST",headers:{...t,"Content-Type":"application/json"},body:JSON.stringify(o)});if(!a.ok){if(a.status===401){this._handleAuthError();return}else if(a.status===403){this._handleAuthorizationError();return}const t=await a.json().catch(()=>({}));throw new Error(t.error?.message||`HTTP ${a.status}: ${a.statusText}`)}s.show(`Student enrolled successfully with status: ${n}`);this._addEnrollmentDialog.close();this.getView().getModel().refresh();if(this._tabsLoaded.enrollments){this._loadEnrollments()}}catch(t){console.error("Failed to create enrollment:",t);o.error(`Failed to create enrollment: ${t.message}`)}},onEditEnrollment:async function(t){const s=t.getSource().getParent().getParent();const o=s.getBindingContext("enrollments");const n=o.getObject();const r=`${n.student?.firstName||""} ${n.student?.lastName||""}`.trim();const a=n.course?.courseName||"Unknown Course";const i=new e({title:"Edit Enrollment",ID:n.ID,studentName:r,courseName:a,status:n.status,grade:n.grade,course_ID:n.course_ID});this._openEnrollmentDialog(i)},_openEnrollmentDialog:async function(t){if(!this._enrollmentDialog){this._enrollmentDialog=await n.load({id:this.getView().getId(),name:"admin.view.EnrollmentDialog",controller:this});this.getView().addDependent(this._enrollmentDialog)}this._enrollmentDialog.setModel(t,"dialogModel");this._enrollmentDialog.open()},onSaveEnrollment:async function(){const t=this._enrollmentDialog.getModel("dialogModel");const e=t.getData();if(e.grade!==null&&e.grade!==undefined&&e.grade!==""){const t=parseFloat(e.grade);if(isNaN(t)){o.error("Grade must be a valid number");return}if(t<0||t>20){o.error("Grade must be between 0 and 20");return}}let s=`Are you sure you want to update this enrollment?\n\n`;s+=`Student: ${e.studentName}\n`;s+=`Course: ${e.courseName}\n`;if(e.grade!==null&&e.grade!==undefined&&e.grade!==""){const t=parseFloat(e.grade);let o;if(t>=18)o="EXCELLENT";else if(t>=16)o="VERY_GOOD";else if(t>=14)o="GOOD";else if(t>=12)o="SATISFACTORY";else if(t>=10)o="PASSED";else o="FAILED";s+=`New Grade: ${t}\n`;s+=`New Status: ${o}\n\n`;s+=`⚠️ This will update the student's grade and status.`}else{s+=`Action: Clear grade\n`;s+=`New Status: ENROLLED\n\n`;s+=`⚠️ This will clear the grade and revert status to ENROLLED.\nThe student will count toward the course quota again.`}o.confirm(s,{title:"Confirm Enrollment Update",actions:[o.Action.OK,o.Action.CANCEL],onClose:async t=>{if(t!==o.Action.OK){return}await this._performEnrollmentUpdate(e)}})},_performEnrollmentUpdate:async function(t){try{const e=await this._getAuthHeaders();const o={};if(t.grade!==null&&t.grade!==undefined&&t.grade!==""){o.grade=parseFloat(t.grade)}else{o.grade=null}const n=await fetch(`/admin/Enrollments(${t.ID})`,{method:"PATCH",headers:{...e,"Content-Type":"application/json"},body:JSON.stringify(o)});if(!n.ok){if(n.status===401){this._handleAuthError();return}else if(n.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${n.status}: ${n.statusText}`)}s.show("Enrollment updated successfully. Status automatically set based on grade.");this._enrollmentDialog.close();this.getView().getModel().refresh();if(this._tabsLoaded.enrollments){this._loadEnrollments()}}catch(t){console.error("Failed to save enrollment:",t);o.error("Failed to save enrollment. Please try again.")}},onDeleteEnrollment:async function(t){const e=t.getSource().getParent().getParent();const s=e.getBindingContext("enrollments");const n=s.getObject();const r=`${n.student?.firstName||""} ${n.student?.lastName||"Unknown"}`;const a=n.course?.courseName||"Unknown Course";o.warning(`Are you sure you want to delete this enrollment?\n\nStudent: ${r}\nCourse: ${a}\nStatus: ${n.status}`,{title:"Confirm Delete",actions:[o.Action.DELETE,o.Action.CANCEL],emphasizedAction:o.Action.DELETE,onClose:async t=>{if(t===o.Action.DELETE){await this._deleteEnrollment(n.ID)}}})},_deleteEnrollment:async function(t){try{const e=await this._getAuthHeaders();const o=await fetch(`/admin/Enrollments(${t})`,{method:"DELETE",headers:e});if(!o.ok){throw new Error(`HTTP ${o.status}: ${o.statusText}`)}s.show("Enrollment deleted successfully");this.getView().getModel().refresh();if(this._tabsLoaded.enrollments){this._loadEnrollments()}if(this._tabsLoaded.courses){this._loadCourses()}}catch(t){console.error("Failed to delete enrollment:",t);o.error("Failed to delete enrollment. Please try again.")}},formatStatusState:function(t){switch(t){case"ENROLLED":return"Information";case"EXCELLENT":return"Success";case"VERY_GOOD":return"Success";case"GOOD":return"Success";case"SATISFACTORY":return"Warning";case"PASSED":return"Warning";case"FAILED":return"Error";case"COMPLETED":return"Success";case"DROPPED":return"None";default:return"None"}},formatActiveText:function(t){return t?"Active":"Inactive"},formatActiveState:function(t){return t?"Success":"None"},_loadDepartments:async function(){if(this._departmentsModel){return}try{const t=await this._getAuthHeaders();const s=await fetch("/admin/Departments",{headers:t});if(!s.ok){throw new Error("Failed to load departments")}const o=await s.json();this._departmentsModel=new e(o.value)}catch(t){console.error("Failed to load departments:",t);o.error("Failed to load departments")}},_loadInstructorsForDropdown:async function(){if(this._instructorsModel){return}try{const t=await this._getAuthHeaders();const s=await fetch("/admin/Instructors",{headers:t});if(!s.ok){throw new Error("Failed to load instructors")}const o=await s.json();this._instructorsModel=new e(o.value)}catch(t){console.error("Failed to load instructors:",t);o.error("Failed to load instructors")}},onCancelDialog:function(){if(this._studentDialog&&this._studentDialog.isOpen()){this._studentDialog.close()}if(this._instructorDialog&&this._instructorDialog.isOpen()){this._instructorDialog.close()}if(this._courseDialog&&this._courseDialog.isOpen()){this._courseDialog.close()}if(this._enrollmentDialog&&this._enrollmentDialog.isOpen()){this._enrollmentDialog.close()}if(this._addEnrollmentDialog&&this._addEnrollmentDialog.isOpen()){this._addEnrollmentDialog.close()}},_handleError:function(t,e){console.error(`[${e}] Error:`,t);s.show(`Failed to ${e}. Please try again.`)},_handleAuthError:function(){o.error("Your session has expired. Please log in again.",{onClose:async function(){await window.AuthService.login()}})},_handleAuthorizationError:function(){o.error("You don't have permission to access this resource.",{onClose:function(){window.location.href="../../launchpad.html"}})}})});
//# sourceMappingURL=Main.controller.js.map