sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox"],function(t,e,o,s){"use strict";return t.extend("instructor.controller.Main",{onInit:function(){console.log("Instructor Main Controller initialized");const t=new e({firstName:"",lastName:"",email:"",departmentName:""});this.getView().setModel(t,"profile");const o=new e({courses:[]});this.getView().setModel(o,"courses");const s=new e({enrollments:[]});this.getView().setModel(s,"enrollments");this._tabsLoaded={courses:false,enrollments:false,statistics:false};this._charts={};setTimeout(()=>{this._loadInstructorProfile()},500)},onAfterRendering:function(){if(!this._tabsLoaded.courses){setTimeout(()=>{this._loadInstructorCourses();this._tabsLoaded.courses=true},500)}},onTabSelect:function(t){const e=t.getParameter("key");if(e==="courses"&&!this._tabsLoaded.courses){this._loadInstructorCourses();this._tabsLoaded.courses=true}else if(e==="enrollments"&&!this._tabsLoaded.enrollments){this._loadEnrollments();this._tabsLoaded.enrollments=true}else if(e==="statistics"&&!this._tabsLoaded.statistics){this._loadStatistics();this._tabsLoaded.statistics=true}},onNavBack:function(){window.location.href="/launchpad.html"},onLogout:async function(){if(typeof window.AuthService!=="undefined"){await window.AuthService.logout()}else{window.location.href="../../launchpad.html"}},_loadInstructorProfile:async function(){try{if(typeof window.AuthService==="undefined"){console.error("AuthService not available");o.show("Authentication service not available");return}const t=await window.AuthService.getUser();console.log("Instructor user:",t);const e=this.getView().getModel("profile");e.setProperty("/email",t.email||"");const s=await window.AuthService.getToken();const r="/instructor/Instructors";console.log("Fetching from URL:",r);const a=await fetch(r,{headers:{Authorization:"Bearer "+s,"X-User-Email":t.email,"X-User-Role":t["https://courseregistration.com/role"]||t["custom:role"]||t.role||"instructor"}});if(!a.ok){if(a.status===401){this._handleAuthError();return}else if(a.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${a.status}: ${a.statusText}`)}const n=await a.json();console.log("Instructor profile response:",n);const i=n.value&&n.value[0]?n.value[0]:n;console.log("Setting profile data:",i);e.setProperty("/firstName",i.firstName||"");e.setProperty("/lastName",i.lastName||"");e.setProperty("/departmentName",i.department?.departmentName||i.departmentName||"");console.log("Profile model after update:",e.getData())}catch(t){console.error("Failed to load instructor profile:",t);this._handleError(t,"load instructor profile")}},_loadInstructorCourses:async function(){const t=this.byId("courseTable");try{console.log("Loading instructor courses...");if(t){t.setBusy(true)}const e=await window.AuthService.getToken();const o=await window.AuthService.getUser();const s="/instructor/Courses";console.log("Fetching from URL:",s);const r=await fetch(s,{headers:{Authorization:"Bearer "+e,"X-User-Email":o.email,"X-User-Role":o["https://courseregistration.com/role"]||o["custom:role"]||o.role||"instructor"}});if(!r.ok){if(r.status===401){this._handleAuthError();return}else if(r.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${r.status}: ${r.statusText}`)}const a=await r.json();console.log("Instructor courses loaded:",a);console.log("Number of courses:",a.value?a.value.length:0);const n=this.getView().getModel("courses");if(!n){console.error("Courses model not found!");return}n.setProperty("/courses",a.value||[]);console.log("Courses model updated. Current data:",n.getData())}catch(t){console.error("Failed to load instructor courses:",t);this._handleError(t,"load instructor courses")}finally{if(t){t.setBusy(false)}}},_loadEnrollments:async function(){const t=this.byId("enrollmentTable");try{console.log("Loading enrollments...");if(t){t.setBusy(true)}const e=await window.AuthService.getToken();const o=await window.AuthService.getUser();const s="/instructor/Enrollments?$expand=student,course";console.log("Fetching from URL:",s);const r=await fetch(s,{headers:{Authorization:"Bearer "+e,"X-User-Email":o.email,"X-User-Role":o["https://courseregistration.com/role"]||o["custom:role"]||o.role||"instructor"}});if(!r.ok){if(r.status===401){this._handleAuthError();return}else if(r.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${r.status}: ${r.statusText}`)}const a=await r.json();console.log("Enrollments loaded:",a);console.log("Number of enrollments:",a.value?a.value.length:0);if(a.value&&a.value.length>0){console.log("First enrollment sample:",JSON.stringify(a.value[0],null,2))}const n=this.getView().getModel("enrollments");if(!n){console.error("Enrollments model not found!");return}n.setProperty("/enrollments",a.value||[]);console.log("Enrollments model updated. Current data:",n.getData())}catch(t){console.error("Failed to load enrollments:",t);this._handleError(t,"load enrollments")}finally{if(t){t.setBusy(false)}}},onUpdateGrade:async function(t){const e=t.getSource();let o=null;try{const t=e.getBindingContext("enrollments");const r=t.getObject();console.log("Updating grade for enrollment:",r);const a=e.getParent();const n=a.getCells();o=n[6];const i=o.getValue().trim();o.setValueState("None");let l={};if(!i){l={grade:null,status:"ENROLLED"}}else{const t=parseFloat(i);if(isNaN(t)){s.warning("Grade must be a valid number.");o.setValueState("Error");o.setValueStateText("Grade must be a number");return}if(t<0||t>20){s.warning("Grade must be between 0 and 20.");o.setValueState("Error");o.setValueStateText("Grade must be between 0 and 20");return}let e;if(t>=18){e="EXCELLENT"}else if(t>=16){e="VERY_GOOD"}else if(t>=14){e="GOOD"}else if(t>=12){e="SATISFACTORY"}else if(t>=10){e="PASSED"}else{e="FAILED"}l={grade:t,status:e}}const c=`${r.student?.firstName} ${r.student?.lastName}`;const u=r.course?.courseName||"Unknown Course";let d=`Are you sure you want to update the grade?\n\n`;d+=`Student: ${c}\n`;d+=`Course: ${u}\n`;d+=`Current Status: ${r.status}\n\n`;if(l.grade===null){d+=`Action: Clear grade\n`;d+=`New Status: ENROLLED\n\n`;d+=`⚠️ This will clear the grade and revert status to ENROLLED.\nThe student will count toward the course quota again.`}else{d+=`New Grade: ${l.grade}\n`;d+=`New Status: ${l.status}\n\n`;d+=`⚠️ This will update the student's grade and status.`}s.confirm(d,{title:"Confirm Grade Update",actions:[s.Action.OK,s.Action.CANCEL],onClose:async t=>{if(t!==s.Action.OK){return}e.setEnabled(false);e.setBusy(true);o.setEnabled(false);await this._performGradeUpdate(r,l,e,o,c)}})}catch(t){console.error("Failed to update grade:",t);s.error(`Failed to update grade: ${t.message}`)}},_performGradeUpdate:async function(t,e,r,a,n){try{const s=await window.AuthService.getToken();const r=await window.AuthService.getUser();const a=await fetch(`/instructor/Enrollments(${t.ID})`,{method:"PATCH",headers:{Authorization:"Bearer "+s,"Content-Type":"application/json","X-User-Email":r.email,"X-User-Role":r["https://courseregistration.com/role"]||r["custom:role"]||r.role||"instructor"},body:JSON.stringify(e)});if(!a.ok){if(a.status===401){this._handleAuthError();return}else if(a.status===403){this._handleAuthorizationError();return}const t=await a.json().catch(()=>({}));throw new Error(t.error?.message||`HTTP ${a.status}: ${a.statusText}`)}const i=await a.json();console.log("Grade updated:",i);if(e.grade===null){o.show(`Grade cleared. Status reverted to ENROLLED for ${n}`)}else{o.show(`Grade ${e.grade} saved. Status updated to ${e.status} for ${n}`)}this._refreshEnrollments()}catch(t){console.error("Failed to update grade:",t);s.error(`Failed to update grade: ${t.message}`)}finally{r.setEnabled(true);r.setBusy(false);if(a){a.setEnabled(true)}}},_refreshEnrollments:function(){const t=this.getView().getModel();if(t){t.refresh()}this._tabsLoaded.enrollments=false;this._loadEnrollments();this._tabsLoaded.enrollments=true},formatStatusState:function(t){switch(t){case"ENROLLED":return"Information";case"EXCELLENT":return"Success";case"VERY_GOOD":return"Success";case"GOOD":return"Success";case"SATISFACTORY":return"Warning";case"PASSED":return"Warning";case"FAILED":return"Error";case"COMPLETED":return"Success";case"DROPPED":return"None";default:return"None"}},_handleError:function(t,e){console.error(`[${e}] Error:`,t);o.show(`Failed to ${e}. Please try again.`)},_handleAuthError:function(){s.error("Your session has expired. Please log in again.",{onClose:async function(){await window.AuthService.login()}})},_handleAuthorizationError:function(){s.error("You don't have permission to access this resource.",{onClose:function(){window.location.href="../../launchpad.html"}})},_loadStatistics:async function(){try{console.log("Loading instructor statistics...");const t=await window.AuthService.getToken();const e=await window.AuthService.getUser();const[o,s]=await Promise.all([fetch("/instructor/Courses",{headers:{Authorization:"Bearer "+t,"X-User-Email":e.email,"X-User-Role":e["https://courseregistration.com/role"]||e["custom:role"]||e.role||"instructor"}}),fetch("/instructor/Enrollments",{headers:{Authorization:"Bearer "+t,"X-User-Email":e.email,"X-User-Role":e["https://courseregistration.com/role"]||e["custom:role"]||e.role||"instructor"}})]);if(!o.ok||!s.ok){throw new Error("Failed to load statistics data")}const r=await o.json();const a=await s.json();console.log("Statistics data loaded");setTimeout(()=>{this._renderCourseCapacityChart(r.value||[]);this._renderGradeDistributionChart(a.value||[]);this._renderEnrollmentStatusChart(a.value||[])},500)}catch(t){console.error("Failed to load statistics:",t);o.show("Failed to load statistics")}},_renderCourseCapacityChart:function(t){const e=document.getElementById("instructorCourseCapacityChart");if(!e){console.warn("Course capacity chart canvas not found");return}if(this._charts.courseCapacity){this._charts.courseCapacity.destroy()}const o=t.map(t=>t.courseCode);const s=t.map(t=>t.enrolled||0);const r=t.map(t=>(t.quota||0)-(t.enrolled||0));const a=e.getContext("2d");this._charts.courseCapacity=new Chart(a,{type:"bar",data:{labels:o,datasets:[{label:"Enrolled",data:s,backgroundColor:"#0070F2"},{label:"Available",data:r,backgroundColor:"#E0E0E0"}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:"Course Enrollment Capacity",font:{size:14}}},scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}}})},_renderGradeDistributionChart:function(t){const e=document.getElementById("instructorGradeChart");if(!e){console.warn("Grade chart canvas not found");return}if(this._charts.grades){this._charts.grades.destroy()}const o={"A (18-20)":0,"B (15-17.9)":0,"C (12-14.9)":0,"D (10-11.9)":0,"F (<10)":0,"No Grade":0};t.forEach(t=>{const e=t.grade;if(e===null||e===undefined){o["No Grade"]++}else if(e>=18)o["A (18-20)"]++;else if(e>=15)o["B (15-17.9)"]++;else if(e>=12)o["C (12-14.9)"]++;else if(e>=10)o["D (10-11.9)"]++;else o["F (<10)"]++});const s=e.getContext("2d");this._charts.grades=new Chart(s,{type:"pie",data:{labels:Object.keys(o),datasets:[{data:Object.values(o),backgroundColor:["#107E3E","#0070F2","#E9730C","#C0399F","#D04343","#E0E0E0"]}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:"Grade Distribution Across All Courses",font:{size:14}},legend:{position:"bottom"}}}})},_renderEnrollmentStatusChart:function(t){const e=document.getElementById("instructorStatusChart");if(!e){console.warn("Status chart canvas not found");return}if(this._charts.status){this._charts.status.destroy()}const o={};t.forEach(t=>{const e=t.status||"Unknown";o[e]=(o[e]||0)+1});const s=e.getContext("2d");this._charts.status=new Chart(s,{type:"doughnut",data:{labels:Object.keys(o),datasets:[{data:Object.values(o),backgroundColor:["#0070F2","#107E3E","#E9730C"]}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:"Enrollment Status Overview",font:{size:14}},legend:{position:"bottom"}}}})}})});
//# sourceMappingURL=Main.controller.js.map