sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox"],function(t,e,s,o){"use strict";return t.extend("student.controller.Main",{onInit:function(){console.log("Main Controller initialized - UI5 PROPER VERSION!");const t=new e({studentNumber:"Loading...",firstName:"",lastName:"",email:"",departmentName:"Loading...",faculty:"Loading...",ectsLimit:60,ectsUsed:0,ectsAvailable:60});this.getView().setModel(t,"profile");const s=new e({courses:[]});this.getView().setModel(s,"courses");const o=new e({enrollments:[]});this.getView().setModel(o,"enrollments");this._tabsLoaded={available:false,enrollments:false,statistics:false};this._charts={};setTimeout(()=>{this._loadStudentProfile()},500)},onAfterRendering:function(){if(!this._tabsLoaded.available){setTimeout(()=>{this._loadAvailableCourses();this._tabsLoaded.available=true},500)}},onTabSelect:function(t){const e=t.getParameter("key");if(e==="available"&&!this._tabsLoaded.available){this._loadAvailableCourses();this._tabsLoaded.available=true}else if(e==="enrollments"&&!this._tabsLoaded.enrollments){this._loadMyEnrollments();this._tabsLoaded.enrollments=true}else if(e==="statistics"&&!this._tabsLoaded.statistics){this._loadStatistics();this._tabsLoaded.statistics=true}},onNavBack:function(){window.location.href="/launchpad.html"},onLogout:async function(){if(typeof window.AuthService!=="undefined"){await window.AuthService.logout()}else{window.location.href="../../launchpad.html"}},_loadStudentProfile:async function(){const t=this.getView();const e=this.byId("profilePanel");try{if(typeof window.AuthService==="undefined"){console.error("AuthService not available");s.show("Authentication service not available");return}if(e){e.setBusy(true)}const t=await window.AuthService.getToken();const o=await window.AuthService.getUser();const r=await fetch("/student/MyProfile",{headers:{Authorization:"Bearer "+t,"X-User-Email":o.email,"X-User-Role":o["https://courseregistration.com/role"]||o["custom:role"]||o.role||"student"}});if(!r.ok){if(r.status===401){this._handleAuthError();return}else if(r.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${r.status}: ${r.statusText}`)}const a=await r.json();console.log("Student profile response:",a);const n=a.value&&a.value[0]?a.value[0]:a;console.log("Student profile loaded:",n);const i=this.getView().getModel("profile");i.setProperty("/studentNumber",n.studentNumber||"N/A");i.setProperty("/firstName",n.firstName||"");i.setProperty("/lastName",n.lastName||"");i.setProperty("/email",n.email||"");i.setProperty("/departmentName",n.departmentName||"N/A");i.setProperty("/faculty",n.faculty||"N/A");i.setProperty("/ectsLimit",n.ectsLimit||60);this._calculateECTS()}catch(t){console.error("Failed to load profile:",t);this._handleError(t,"load student profile")}finally{if(e){e.setBusy(false)}}},_calculateECTS:async function(){try{const t=await window.AuthService.getToken();const e=await window.AuthService.getUser();const s="/student/MyEnrollments?$expand=course";const o=await fetch(s,{headers:{Authorization:"Bearer "+t,"X-User-Email":e.email,"X-User-Role":e["https://courseregistration.com/role"]||e["custom:role"]||e.role||"student"}});if(!o.ok){if(o.status===401){this._handleAuthError();return}else if(o.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${o.status}: ${o.statusText}`)}const r=await o.json();let a=0;if(r.value){r.value.forEach(t=>{if(t.status==="ENROLLED"||t.status==="COMPLETED"){a+=t.ects||0}})}const n=this.getView().getModel("profile");const i=n.getProperty("/ectsLimit");n.setProperty("/ectsUsed",a);n.setProperty("/ectsAvailable",i-a)}catch(t){console.error("Failed to calculate ECTS:",t);this._handleError(t,"calculate ECTS")}},_loadAvailableCourses:async function(){const t=this.byId("courseTable");try{console.log("Loading available courses...");if(t){t.setBusy(true)}const e=await window.AuthService.getToken();const s=await window.AuthService.getUser();const o="/student/AvailableCourses";console.log("Fetching from URL:",o);const r=await fetch(o,{headers:{Authorization:"Bearer "+e,"X-User-Email":s.email,"X-User-Role":s["https://courseregistration.com/role"]||s["custom:role"]||s.role||"student"}});if(!r.ok){if(r.status===401){this._handleAuthError();return}else if(r.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${r.status}: ${r.statusText}`)}const a=await r.json();console.log("Available courses loaded:",a);console.log("Number of courses:",a.value?a.value.length:0);const n=this.getView().getModel("courses");if(!n){console.error("Courses model not found!");return}n.setProperty("/courses",a.value||[]);console.log("Courses model updated. Current data:",n.getData())}catch(t){console.error("Failed to load available courses:",t);this._handleError(t,"load available courses")}finally{if(t){t.setBusy(false)}}},_loadMyEnrollments:async function(){const t=this.byId("enrollmentTable");try{console.log("Loading my enrollments...");if(t){t.setBusy(true)}const e=await window.AuthService.getToken();const s=await window.AuthService.getUser();const o="/student/MyEnrollments";console.log("Fetching from URL:",o);const r=await fetch(o,{headers:{Authorization:"Bearer "+e,"X-User-Email":s.email,"X-User-Role":s["https://courseregistration.com/role"]||s["custom:role"]||s.role||"student"}});if(!r.ok){if(r.status===401){this._handleAuthError();return}else if(r.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${r.status}: ${r.statusText}`)}const a=await r.json();console.log("My enrollments loaded:",a);const n=this.getView().getModel("enrollments");n.setProperty("/enrollments",a.value||[]);this._calculateECTS()}catch(t){console.error("Failed to load enrollments:",t);this._handleError(t,"load enrollments")}finally{if(t){t.setBusy(false)}}},_loadStatistics:async function(){try{console.log("Loading statistics...");const t=await window.AuthService.getToken();const e=await window.AuthService.getUser();const[s,o]=await Promise.all([fetch("/student/AvailableCourses",{headers:{Authorization:"Bearer "+t,"X-User-Email":e.email,"X-User-Role":e["https://courseregistration.com/role"]||e["custom:role"]||e.role||"student"}}),fetch("/student/MyEnrollments",{headers:{Authorization:"Bearer "+t,"X-User-Email":e.email,"X-User-Role":e["https://courseregistration.com/role"]||e["custom:role"]||e.role||"student"}})]);if(!s.ok){if(s.status===401){this._handleAuthError();return}else if(s.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${s.status}: ${s.statusText}`)}if(!o.ok){if(o.status===401){this._handleAuthError();return}else if(o.status===403){this._handleAuthorizationError();return}throw new Error(`HTTP ${o.status}: ${o.statusText}`)}const r=await s.json();const a=await o.json();console.log("Statistics - Available courses data:",r);console.log("Statistics - Available courses count:",r.value?r.value.length:0);console.log("Statistics - Enrollments data:",a);console.log("Statistics - Enrollments count:",a.value?a.value.length:0);const n=[...r.value||[]];const i=await fetch("/student/MyEnrollments?$expand=course",{headers:{Authorization:"Bearer "+t,"X-User-Email":e.email,"X-User-Role":e["https://courseregistration.com/role"]||e["custom:role"]||e.role||"student"}});if(i.ok){const t=await i.json();console.log("Statistics - Enrollments with courses:",t);if(t.value){t.value.forEach(t=>{if(t.course){const e=n.find(e=>e.ID===t.course.ID);if(!e){n.push(t.course)}}})}}console.log("Statistics - Final courses array:",n);console.log("Statistics - Final courses array length:",n.length);setTimeout(()=>{this._renderCourseCapacityChart(n);this._renderEctsChart();this._renderEnrollmentStatusChart(a.value||[])},300)}catch(t){console.error("Failed to load statistics:",t);this._handleError(t,"load statistics")}},_renderCourseCapacityChart:function(t){console.log("_renderCourseCapacityChart called with courses:",t);console.log("Courses type:",typeof t,"Is array:",Array.isArray(t),"Length:",t?t.length:"N/A");const e=document.getElementById("courseCapacityChart");if(!e){console.error("Course capacity chart canvas not found");return}console.log("Canvas element found:",e);if(this._charts.courseCapacity){console.log("Destroying existing chart");this._charts.courseCapacity.destroy()}if(!t||!Array.isArray(t)||t.length===0){console.warn("No courses data available for chart - courses:",t);this._charts.courseCapacity=new Chart(e,{type:"bar",data:{labels:[],datasets:[]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:"No course data available"}}}});return}console.log("Valid courses array with",t.length,"courses");const s=t.sort((t,e)=>(e.enrolled||0)-(t.enrolled||0)).slice(0,10);console.log("Rendering course capacity chart with courses:",s);const o=s.map(t=>t.courseCode||"N/A");const r=s.map(t=>t.enrolled||0);const a=s.map(t=>Math.max(0,(t.quota||0)-(t.enrolled||0)));console.log("Chart data - Labels:",o,"Enrolled:",r,"Available:",a);this._charts.courseCapacity=new Chart(e,{type:"bar",data:{labels:o,datasets:[{label:"Enrolled",data:r,backgroundColor:"rgba(54, 162, 235, 0.8)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1},{label:"Available",data:a,backgroundColor:"rgba(75, 192, 192, 0.8)",borderColor:"rgba(75, 192, 192, 1)",borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true,title:{display:true,text:"Course Code"}},y:{stacked:true,beginAtZero:true,title:{display:true,text:"Number of Students"}}},plugins:{title:{display:true,text:"Top 10 Courses by Enrollment"},legend:{display:true,position:"top"}}}})},_renderEctsChart:function(){const t=document.getElementById("ectsChart");if(!t)return;if(this._charts.ects){this._charts.ects.destroy()}const e=this.getView().getModel("profile");const s=e.getProperty("/ectsUsed")||0;const o=e.getProperty("/ectsAvailable")||0;this._charts.ects=new Chart(t,{type:"doughnut",data:{labels:["ECTS Used","ECTS Available"],datasets:[{data:[s,o],backgroundColor:["rgba(255, 99, 132, 0.8)","rgba(75, 192, 192, 0.8)"],borderColor:["rgba(255, 99, 132, 1)","rgba(75, 192, 192, 1)"],borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:"My ECTS Distribution"},legend:{display:true,position:"bottom"}}}})},_renderEnrollmentStatusChart:function(t){const e=document.getElementById("statusChart");if(!e)return;if(this._charts.status){this._charts.status.destroy()}const s={};t.forEach(t=>{const e=t.status||"UNKNOWN";s[e]=(s[e]||0)+1});const o=Object.keys(s);const r=Object.values(s);const a=o.map(t=>{switch(t){case"ENROLLED":return"rgba(54, 162, 235, 0.9)";case"EXCELLENT":return"rgba(16, 126, 62, 0.9)";case"VERY_GOOD":return"rgba(43, 125, 43, 0.9)";case"GOOD":return"rgba(16, 185, 129, 0.9)";case"SATISFACTORY":return"rgba(245, 158, 11, 0.9)";case"PASSED":return"rgba(233, 115, 12, 0.9)";case"FAILED":return"rgba(208, 67, 67, 0.9)";case"COMPLETED":return"rgba(16, 126, 62, 0.9)";case"DROPPED":return"rgba(91, 115, 139, 0.9)";default:return"rgba(149, 165, 166, 0.9)"}});this._charts.status=new Chart(e,{type:"pie",data:{labels:o,datasets:[{data:r,backgroundColor:a,borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:"Enrollment Status Breakdown"},legend:{display:true,position:"bottom"}}}})},onEnroll:async function(t){const e=t.getSource();try{const t=e.getBindingContext("courses");const s=t.getObject();console.log("Enrolling in course:",s);const r=this.getView().getModel("profile");const a=r.getProperty("/ectsAvailable");const n=s.ects||0;if(a<n){o.error(`Insufficient ECTS available. You need ${n} ECTS but only have ${a} ECTS available.`);return}if(s.enrolled>=s.quota){o.error("This course is full. Please select another course.");return}let i=`Are you sure you want to enroll in this course?\n\n`;i+=`Course: ${s.courseName} (${s.courseCode})\n`;i+=`ECTS: ${n}\n`;i+=`Instructor: ${s.instructor?.firstName} ${s.instructor?.lastName}\n`;i+=`Semester: ${s.semester}\n\n`;i+=`Available ECTS after enrollment: ${a-n} / ${r.getProperty("/ectsLimit")}\n`;i+=`Course availability: ${s.enrolled+1} / ${s.quota} enrolled`;o.confirm(i,{title:"Confirm Enrollment",actions:[o.Action.OK,o.Action.CANCEL],onClose:async t=>{if(t!==o.Action.OK){return}e.setEnabled(false);e.setBusy(true);await this._performEnrollment(s,e)}})}catch(t){console.error("Failed to enroll:",t);o.error(`Failed to enroll: ${t.message}`)}},_performEnrollment:async function(t,e){try{const e=await window.AuthService.getToken();const s=await window.AuthService.getUser();const r={course_ID:t.ID,status:"ENROLLED"};const a=await fetch("/student/Enrollments",{method:"POST",headers:{Authorization:"Bearer "+e,"X-User-Email":s.email,"X-User-Role":s["https://courseregistration.com/role"]||s["custom:role"]||s.role||"student","Content-Type":"application/json"},body:JSON.stringify(r)});if(!a.ok){if(a.status===401){this._handleAuthError();return}else if(a.status===403){this._handleAuthorizationError();return}const t=await a.json().catch(()=>({}));throw new Error(t.error?.message||`HTTP ${a.status}: ${a.statusText}`)}const n=await a.json();console.log("Enrollment created:",n);o.success(`Successfully enrolled in ${t.courseName}!`,{onClose:()=>{this._refreshData()}})}catch(t){console.error("Failed to enroll:",t);o.error(`Failed to enroll in course: ${t.message}`)}finally{e.setEnabled(true);e.setBusy(false)}},_refreshData:function(){this._loadStudentProfile();this._tabsLoaded.available=false;this._tabsLoaded.enrollments=false;this._tabsLoaded.statistics=false;this._loadAvailableCourses();this._loadMyEnrollments();this._tabsLoaded.available=true;this._tabsLoaded.enrollments=true;const t=this.byId("iconTabBar");if(t){const e=t.getSelectedKey();if(e==="statistics"){this._loadStatistics();this._tabsLoaded.statistics=true}}},formatEctsState:function(t){const e=parseInt(t)||0;if(e>10)return"Success";if(e>0)return"Warning";return"Error"},formatQuotaText:function(t,e){return(t||0)+"/"+(e||0)},formatQuotaStatus:function(t,e){return t>=e?"Full":"Available"},formatQuotaState:function(t,e){return t>=e?"Error":"Success"},formatEnrollEnabled:function(t,e){return t<e},formatStatusState:function(t){switch(t){case"ENROLLED":return"Information";case"COMPLETED":return"Success";default:return"Warning"}},_handleError:function(t,e){console.error(`[${e}] Error:`,t);s.show(`Failed to ${e}. Please try again.`)},_handleAuthError:function(){o.error("Your session has expired. Please log in again.",{onClose:async function(){await window.AuthService.login()}})},_handleAuthorizationError:function(){o.error("You don't have permission to access this resource.",{onClose:function(){window.location.href="../../launchpad.html"}})}})});
//# sourceMappingURL=Main.controller.js.map